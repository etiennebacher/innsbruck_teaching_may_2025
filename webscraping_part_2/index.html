<!DOCTYPE html>
<html lang="en"><head>
<script src="index_files/libs/clipboard/clipboard.min.js"></script>
<script src="index_files/libs/quarto-html/tabby.min.js"></script>
<script src="index_files/libs/quarto-html/popper.min.js"></script>
<script src="index_files/libs/quarto-html/tippy.umd.min.js"></script>
<link href="index_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="index_files/libs/quarto-html/light-border.css" rel="stylesheet">
<link href="index_files/libs/quarto-html/quarto-syntax-highlighting-dark-391c4f7f0df7475a7487d1067a5e1fc7.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<link href="index_files/libs/quarto-contrib/fontawesome6-0.1.0/all.css" rel="stylesheet">
<link href="index_files/libs/quarto-contrib/fontawesome6-0.1.0/latex-fontsize.css" rel="stylesheet"><meta charset="utf-8">
  <meta name="generator" content="quarto-1.6.40">

  <title>Webscraping – Part 2</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">
  <link rel="stylesheet" href="index_files/libs/revealjs/dist/reset.css">
  <link rel="stylesheet" href="index_files/libs/revealjs/dist/reveal.css">
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      width: 0.8em;
      margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
      vertical-align: middle;
    }
    /* CSS for syntax highlighting */
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
      }
    pre.numberSource { margin-left: 3em;  padding-left: 4px; }
    div.sourceCode
      { color: #abb2bf;  }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span { color: #abb2bf; } /* Normal */
    code span.al { color: #95da4c; background-color: #4d1f24; font-weight: bold; } /* Alert */
    code span.an { color: #98c379; } /* Annotation */
    code span.at { color: #c678dd; } /* Attribute */
    code span.bn { color: #d19a66; } /* BaseN */
    code span.bu { color: #c678dd; } /* BuiltIn */
    code span.cf { color: #c678dd; } /* ControlFlow */
    code span.ch { color: #98c379; } /* Char */
    code span.cn { color: #d19a66; } /* Constant */
    code span.co { color: #5c6370; font-style: italic; } /* Comment */
    code span.cv { color: #e06c75; font-style: italic; } /* CommentVar */
    code span.do { color: #a43340; } /* Documentation */
    code span.dt { color: #c678dd; } /* DataType */
    code span.dv { color: #d19a66; } /* DecVal */
    code span.er { color: #f44747; text-decoration: underline; } /* Error */
    code span.ex { color: #61afef; font-weight: bold; } /* Extension */
    code span.fl { color: #d19a66; } /* Float */
    code span.fu { color: #61afef; } /* Function */
    code span.im { color: #98c379; } /* Import */
    code span.in { color: #c45b00; } /* Information */
    code span.kw { color: #c678dd; } /* Keyword */
    code span.op { color: #c678dd; } /* Operator */
    code span.ot { color: #27ae60; } /* Other */
    code span.pp { color: #c678dd; } /* Preprocessor */
    code span.re { color: #2980b9; background-color: #153042; } /* RegionMarker */
    code span.sc { color: #56b6c2; } /* SpecialChar */
    code span.ss { color: #da4453; } /* SpecialString */
    code span.st { color: #98c379; } /* String */
    code span.va { color: #e06c75; } /* Variable */
    code span.vs { color: #da4453; } /* VerbatimString */
    code span.wa { color: #da4453; } /* Warning */
  </style>
  <link rel="stylesheet" href="index_files/libs/revealjs/dist/theme/quarto-6153582f6cc33c3f40e40e1108ee0ec9.css">
  <link href="index_files/libs/revealjs/plugin/quarto-line-highlight/line-highlight.css" rel="stylesheet">
  <link href="index_files/libs/revealjs/plugin/reveal-menu/menu.css" rel="stylesheet">
  <link href="index_files/libs/revealjs/plugin/reveal-menu/quarto-menu.css" rel="stylesheet">
  <link href="index_files/libs/revealjs/plugin/quarto-support/footer.css" rel="stylesheet">
  <style type="text/css">
    .reveal div.sourceCode {
      margin: 0;
      overflow: auto;
    }
    .reveal div.hanging-indent {
      margin-left: 1em;
      text-indent: -1em;
    }
    .reveal .slide:not(.center) {
      height: 100%;
    }
    .reveal .slide.scrollable {
      overflow-y: auto;
    }
    .reveal .footnotes {
      height: 100%;
      overflow-y: auto;
    }
    .reveal .slide .absolute {
      position: absolute;
      display: block;
    }
    .reveal .footnotes ol {
      counter-reset: ol;
      list-style-type: none; 
      margin-left: 0;
    }
    .reveal .footnotes ol li:before {
      counter-increment: ol;
      content: counter(ol) ". "; 
    }
    .reveal .footnotes ol li > p:first-child {
      display: inline-block;
    }
    .reveal .slide ul,
    .reveal .slide ol {
      margin-bottom: 0.5em;
    }
    .reveal .slide ul li,
    .reveal .slide ol li {
      margin-top: 0.4em;
      margin-bottom: 0.2em;
    }
    .reveal .slide ul[role="tablist"] li {
      margin-bottom: 0;
    }
    .reveal .slide ul li > *:first-child,
    .reveal .slide ol li > *:first-child {
      margin-block-start: 0;
    }
    .reveal .slide ul li > *:last-child,
    .reveal .slide ol li > *:last-child {
      margin-block-end: 0;
    }
    .reveal .slide .columns:nth-child(3) {
      margin-block-start: 0.8em;
    }
    .reveal blockquote {
      box-shadow: none;
    }
    .reveal .tippy-content>* {
      margin-top: 0.2em;
      margin-bottom: 0.7em;
    }
    .reveal .tippy-content>*:last-child {
      margin-bottom: 0.2em;
    }
    .reveal .slide > img.stretch.quarto-figure-center,
    .reveal .slide > img.r-stretch.quarto-figure-center {
      display: block;
      margin-left: auto;
      margin-right: auto; 
    }
    .reveal .slide > img.stretch.quarto-figure-left,
    .reveal .slide > img.r-stretch.quarto-figure-left  {
      display: block;
      margin-left: 0;
      margin-right: auto; 
    }
    .reveal .slide > img.stretch.quarto-figure-right,
    .reveal .slide > img.r-stretch.quarto-figure-right  {
      display: block;
      margin-left: auto;
      margin-right: 0; 
    }
  </style>
</head>
<body class="quarto-dark">
  <div class="reveal">
    <div class="slides">

<section id="title-slide" class="quarto-title-block center">
  <h1 class="title">Webscraping – Part 2</h1>
  <p class="subtitle">Dynamic webscraping</p>

<div class="quarto-title-authors">
</div>

</section>
<section id="reminder" class="slide level2">
<h2>Reminder</h2>
<p><br></p>
<div class="callout callout-important no-icon callout-style-simple">
<div class="callout-body">
<div class="callout-content">
<p>Do you really need scraping?</p>
</div>
</div>
</div>
<p>Before scraping: is there an API?</p>
<div class="increment">
<ul>
<li><p>if yes, is there a package?</p>
<ul>
<li><p>if yes, use the package (e.g.&nbsp;<a href="https://guardian.news-r.org/"><code>guardian</code></a>, <a href="https://vincentarelbundock.github.io/WDI/"><code>WDI</code></a>)</p></li>
<li><p>if no, build the API queries yourself with <a href="https://httr2.r-lib.org/"><code>httr2</code></a></p></li>
</ul></li>
<li><p>if no, scrape (politely)</p></li>
</ul>
</div>
</section>
<section id="reminder-1" class="slide level2">
<h2>Reminder</h2>
<p><br></p>
<p>Scraping can be divided in two steps:</p>
<div>
<ol type="1">
<li class="fragment">getting the HTML that contains the information</li>
<li class="fragment">cleaning the HTML to extract the information we want</li>
</ol>
</div>
<div class="fragment">
<p><br></p>
<p>These 2 steps don’t necessarily require the same tools, and <em>shouldn’t be carried out at the same time</em>.</p>
</div>
</section>
<section id="reminder-2" class="slide level2">
<h2>Reminder</h2>
<p><br></p>
<p>Why?</p>
<p><br></p>
<p>Webscraping takes time, and a lot of things can happen:</p>
<ul>
<li>your Internet connection goes down;</li>
<li>the website goes down;</li>
<li>any other random reason</li>
</ul>
<p><br></p>
<div class="fragment">
<p>If this happens and you didn’t save your progress, you lose <strong>everything</strong>.</p>
<p>We don’t have plenty of time, but we have plenty of disk storage. Use it!</p>
</div>
</section>
<section id="reminder-3" class="slide level2">
<h2>Reminder</h2>
<p><br> <br> <br></p>
<p>Here, we will focus mostly on <strong>how to obtain the HTML code you need on dynamic pages?</strong></p>
<p><br></p>
<p>(And a bit on how to clean this HTML)</p>
</section>
<section>
<section id="reminder-static-and-dynamic-pages" class="title-slide slide level1 center">
<h1>Reminder: static and dynamic pages</h1>

</section>
<section id="static-and-dynamic-pages" class="slide level2">
<h2>Static and dynamic pages</h2>
<p><br><br></p>
<p>The web works with 3 languages:</p>
<div>
<ul>
<li class="fragment">HTML: content and structure of the page</li>
<li class="fragment">CSS: style of the page</li>
<li class="fragment">JavaScript: interactions with the page</li>
</ul>
</div>
</section>
<section id="static-and-dynamic-pages-1" class="slide level2">
<h2>Static and dynamic pages</h2>
<p><br><br></p>
<p>The web works with 3 languages:</p>
<ul>
<li><p>HTML: content and structure of the page</p></li>
<li><p>CSS: style of the page</p></li>
<li><p><span style="color: beige;"><strong>JavaScript</strong>: interactions with the page</span></p></li>
</ul>
</section>
<section id="static-vs-dynamic" class="slide level2">
<h2>Static vs dynamic</h2>
<p><br></p>
<p><strong>Static webpage</strong>:</p>
<ul>
<li>all the information is loaded with the page;</li>
<li>changing a parameter modifies the URL</li>
</ul>
<p>Examples: <a href="https://en.wikipedia.org/wiki/Web_scraping" class="external" target="_blank">Wikipedia</a>, <a href="https://www.imdb.com/name/nm0001392/?ref_=nv_sr_srsg_0" class="external" target="_blank">IMDB</a>.</p>
<p><br></p>
<div class="fragment">
<p><strong>Dynamic webpage</strong>: the website uses JavaScript to fetch data from their server and <em>dynamically</em> update the page.</p>
<p>Example: <a href="https://www.premierleague.com/stats/top/players/goal_assist" class="external" target="_blank">Premier League stats</a>.</p>
</div>
</section></section>
<section>
<section id="why-is-it-harder-to-do-webscraping-with-dynamic-pages" class="title-slide slide level1 center">
<h1>Why is it harder to do webscraping with dynamic pages?</h1>

</section>
<section class="slide level2">

<p><br></p>
<p>Webscraping a static website can be quite simple:</p>
<ul>
<li>you get a list of URLs;</li>
<li>download the HTML for each of them;</li>
<li>read and clean the HTML</li>
</ul>
<p>and that’s it.</p>
<p><br></p>
<div class="fragment">
<p>This is “easy” because you can identify two pages with different content just by looking at their URL.</p>
</div>
</section>
<section class="slide level2">

<p>Example: elections results in Spain from the website of <a href="https://resultados.elpais.com/elecciones/2019/municipales/" class="external" target="_blank">El Pais</a></p>
<p><img data-src="img/elpais1.png" style="width:60.0%"></p>
<p><img data-src="img/elpais2.png" style="width:60.0%"></p>
</section>
<section class="slide level2">

<p><br> <br> <br> <br></p>
<p>Of course, static webscraping can be challenging because we have to write good loops, good error handling, the HTML itself can be hard to clean, etc.</p>
<div class="fragment">
<p><br></p>
<p>But in dynamic pages, there’s no obvious way to see that the inputs are different.</p>
</div>
</section>
<section class="slide level2">

<p>Example: <a href="https://www.premierleague.com/stats/top/players/goal_assist" class="external" target="_blank">Premier League stats</a></p>
<p><img data-src="img/premier-league-1.png" style="width:60.0%"></p>
<p><img data-src="img/premier-league-2.png" style="width:60.0%"></p>
</section>
<section class="slide level2">

<p><br> <br></p>
<p>So it seems that the only way to get the data is to go manually through all pages to get the HTML.</p>
<p><br></p>
<div class="fragment">
<div style="text-align: center">
<p><img src="img/one-eternity-later.jpg" style="width: 70%"></p>
</div>
</div>
</section></section>
<section>
<section id="rselenium" class="title-slide slide level1 center">
<h1>(R)Selenium</h1>

</section>
<section id="idea" class="slide level2">
<h2>Idea</h2>
<p>Idea: control the browser from the command line.</p>
<p><br></p>
<div class="fragment">
<p><em>“I wish I could click on this button to open a modal”</em></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href=""></a>remote_driver<span class="sc">$</span><span class="fu">findElement</span>(<span class="at">using =</span> <span class="st">"css"</span>, <span class="at">value =</span> <span class="st">".my-button"</span>)<span class="sc">$</span><span class="fu">clickElement</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><br></p>
</div>
<div class="fragment">
<p><em>“I wish I could fill these inputs to automatically connect”</em></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href=""></a>remote_driver<span class="sc">$</span><span class="fu">findElement</span>(</span>
<span id="cb2-2"><a href=""></a>  <span class="at">using =</span> <span class="st">"id"</span>,</span>
<span id="cb2-3"><a href=""></a>  <span class="at">value =</span> <span class="st">"password"</span></span>
<span id="cb2-4"><a href=""></a>)<span class="sc">$</span><span class="fu">sendKeysToElement</span>(<span class="fu">list</span>(<span class="st">"my_super_secret_password"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</section>
<section class="slide level2">

<p><br></p>
<p>Almost everything you can do “by hand” in a browser, you can reproduce with Selenium:</p>
<div class="fragment">
<table class="caption-top">
<colgroup>
<col style="width: 65%">
<col style="width: 34%">
</colgroup>
<thead>
<tr class="header">
<th>Action</th>
<th>Code</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Open a browser</td>
<td><code>open()</code> / <code>navigate()</code></td>
</tr>
<tr class="even">
<td>Click on something</td>
<td><code>clickElement()</code></td>
</tr>
<tr class="odd">
<td>Enter values</td>
<td><code>sendKeysToElement()</code></td>
</tr>
<tr class="even">
<td>Go to previous/next page</td>
<td><code>goBack()</code> / <code>goForward()</code></td>
</tr>
<tr class="odd">
<td>Refresh the page</td>
<td><code>refresh()</code></td>
</tr>
<tr class="even">
<td>Get all the HTML that is currently <br> displayed</td>
<td><code>getPageSource()</code></td>
</tr>
</tbody>
</table>
</div>
</section></section>
<section>
<section id="get-started" class="title-slide slide level1 center">
<h1>Get started</h1>

</section>
<section id="get-started-1" class="slide level2">
<h2>Get started</h2>
<p><br></p>
<p>In the beginning was <del>the Word</del> <code>rsDriver()</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href=""></a><span class="co"># if not already installed</span></span>
<span id="cb3-2"><a href=""></a><span class="co"># install.packages("RSelenium")</span></span>
<span id="cb3-3"><a href=""></a><span class="fu">library</span>(RSelenium)</span>
<span id="cb3-4"><a href=""></a></span>
<span id="cb3-5"><a href=""></a>driver <span class="ot">&lt;-</span> <span class="fu">rsDriver</span>(<span class="at">browser =</span> <span class="st">"firefox"</span>, <span class="at">chromever =</span> <span class="cn">NULL</span>) <span class="co"># can also be "chrome"</span></span>
<span id="cb3-6"><a href=""></a>remote_driver <span class="ot">&lt;-</span> driver[[<span class="st">"client"</span>]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p></p>
<div class="fragment">
<p><br></p>
<p>If everything works fine, this will print a bunch of messages and open a “marionette browser”.</p>
<p><img data-src="img/marionette2.png"></p>
</div>
</section>
<section id="installation-issues" class="slide level2">
<h2>Installation issues</h2>
<p><br></p>
<ol type="1">
<li>Java not installed</li>
</ol>
<p><br></p>
<p>Install the package <a href="https://www.ekotov.pro/rJavaEnv/"><code>rJavaEnv</code></a>, and then run <code>rJavaEnv::java_quick_install(version = 21)</code>.</p>
</section>
<section id="installation-issues-1" class="slide level2">
<h2>Installation issues</h2>
<p><br></p>
<ol start="2" type="1">
<li>Firefox not installed/found</li>
</ol>
<p>If you have a message saying “Could not open firefox browser”, two possible explanations:</p>
<ul>
<li><p>if Firefox is not installed, install it.</p></li>
<li><p>if Firefox is installed but not found, it probably means that it wasn’t installed with admin rights, so you need to manually specify the location of the file:</p></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href=""></a>driver <span class="ot">&lt;-</span> <span class="fu">rsDriver</span>(</span>
<span id="cb4-2"><a href=""></a>  <span class="at">browser =</span> <span class="st">"firefox"</span>,</span>
<span id="cb4-3"><a href=""></a>  <span class="at">extraCapabilities =</span> <span class="fu">list</span>(</span>
<span id="cb4-4"><a href=""></a>    <span class="st">`</span><span class="at">moz:firefoxOptions</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">list</span>(</span>
<span id="cb4-5"><a href=""></a>      <span class="at">binary =</span> <span class="st">"C:</span><span class="sc">\\</span><span class="st">Users</span><span class="sc">\\</span><span class="st">&lt;USERNAME&gt;</span><span class="sc">\\</span><span class="st">AppData</span><span class="sc">\\</span><span class="st">Local</span><span class="sc">\\</span><span class="st">Mozilla Firefox</span><span class="sc">\\</span><span class="st">firefox.exe"</span></span>
<span id="cb4-6"><a href=""></a>    )</span>
<span id="cb4-7"><a href=""></a>  )</span>
<span id="cb4-8"><a href=""></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="installation-issues-2" class="slide level2">
<h2>Installation issues</h2>
<p><br></p>
<ol start="3" type="1">
<li>“Error in if (file.access(phantompath, 1) &lt; 0) { : argument is of length zero”</li>
</ol>
<p><br></p>
<p>If you have this error, this is bad news because I don’t really know how to fix it since I never had it.</p>
<p><br></p>
<p>You can try to follow <a href="https://stackoverflow.com/questions/46202062/i-got-error-like-error-in-if-file-accessphantompath-1-0-argument-is-o" class="external" target="_blank">this StackOverflow answer</a>.</p>
</section>
<section id="get-started-2" class="slide level2">
<h2>Get started</h2>
<p>From now on, the main thing is to call <code>&lt;function&gt;()</code> starting with <code>remote_driver$</code><sup>1</sup>.</p>
<p><img src="img/rsdriver_funcs.png" alt="drawing" style="width:75%; text-align: center"></p>
<aside><ol class="aside-footnotes"><li id="fn1"><p>Or whatever you called it in the previous step.</p></li></ol></aside></section>
<section id="closing-selenium" class="slide level2">
<h2>Closing Selenium</h2>
<p><br></p>
<p>The clean way to close <code>Selenium</code> is to run <code>driver$server$stop()</code> (replace <code>driver</code> by the name you gave at the previous step).</p>
<p><br></p>
<p>If you close the browser by hand and try to re-run the script, you may have the following error:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href=""></a><span class="st">"Error in wdman::selenium(port = port, verbose = verbose, version = version,  :</span></span>
<span id="cb5-2"><a href=""></a><span class="st">  Selenium server signals port = 4567 is already in use."</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><br></p>
<p>To get rid of this error, you also need to run <code>driver$server$stop()</code>.</p>
</section></section>
<section>
<section id="exercise-1" class="title-slide slide level1 center">
<h1>Exercise 1</h1>

</section>
<section id="exercise-1-1" class="slide level2">
<h2>Exercise 1</h2>
<p><br></p>
<p><strong>Objective:</strong> get the list of core contributors to R located <a href="https://www.r-project.org/contributors.html" class="external" target="_blank">here</a>.</p>
<div class="fragment">
<p><br></p>
<p>How would you do it by hand?</p>
<ul>
<li>open the browser;</li>
<li>go to <a href="https://r-project.org">https://r-project.org</a>;</li>
<li>in the left sidebar, click on the link “Contributors”;</li>
</ul>
<p>and voilà!</p>
</div>
<div class="fragment">
<p><br></p>
<p>How can we do these steps programmatically?</p>
</div>
</section>
<section id="open-the-browser-and-navigate" class="slide level2">
<h2>Open the browser and navigate</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href=""></a>remote_driver<span class="sc">$</span><span class="fu">navigate</span>(<span class="st">"https://r-project.org"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>

<img src="img/rproject.png" alt="drawing" style="width:75% !important; text-align: center !important" class="r-stretch"></section>
<section id="click-on-contributors" class="slide level2">
<h2>Click on “Contributors”</h2>
<p><br></p>
<p>This requires two things:</p>
<ol type="1">
<li>find the element</li>
<li>click on it</li>
</ol>
<p><br></p>
<p><strong>How to find an element?</strong></p>
<ul>
<li><p>Humans -&gt; eyes</p></li>
<li><p>Computers -&gt; HTML/CSS</p></li>
</ul>
</section>
<section class="slide level2">

<p>To find the element, we need to open the console to see the structure of the page:</p>
<ul>
<li>right-click -&gt; “Inspect”</li>
<li>or <code>Ctrl</code> + <code>Shift</code> + <code>C</code></li>
</ul>
<div class="fragment">
<p><img data-src="img/console.png" style="width:75.0%"></p>
</div>
</section>
<section class="slide level2">

<p><br></p>
<p>Then, hover the element we’re interested in: the link “Contributors”.</p>
<p><br></p>

<img data-src="img/console_2.png" class="r-stretch"></section>
<section class="slide level2">

<p><br><br></p>
<p>How can we find this link with <code>RSelenium</code>?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href=""></a>?RSelenium<span class="sc">::</span><span class="fu">remoteDriver</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><br></p>
<p>-&gt; <code>findElement</code></p>
<div class="fragment">
<div class="columns">
<div class="column" style="width:45%;">
<ul>
<li>class name ❌</li>
<li>id ❌</li>
<li>name ❌</li>
<li>tag name ❌</li>
</ul>
</div><div class="column" style="width:10%;">

</div><div class="column" style="width:45%;">
<ul>
<li>css selector ✔️</li>
<li>link text ✔️</li>
<li>partial link text ✔️</li>
<li>xpath ✔️</li>
</ul>
</div></div>
</div>
</section>
<section class="slide level2">

<p><br></p>
<p>We must make a distinction between two classes of objects: <code>remoteDriver</code> and <code>webElement</code>.</p>
<div class="fragment">
<p><br></p>
<p>Think of <code>remoteDriver</code> as the browser in general: you can navigate between pages, search elements, find if an element is present on the page, etc.</p>
<p><i class="fa-solid fa-arrow-right" aria-hidden="true"></i> &nbsp; see the list of available methods with <code>?remoteDriver</code></p>
</div>
<div class="fragment">
<p><br></p>
<p>Think of <code>webElement</code> as a particular element on the page: you can highlight it, click it, get its text, etc.</p>
<p><i class="fa-solid fa-arrow-right" aria-hidden="true"></i> &nbsp; see the list of available methods with <code>?webElement</code></p>
</div>
</section>
<section class="slide level2">

<div class="callout callout-tip no-icon callout-style-simple">
<div class="callout-body">
<div class="callout-content">
<p><strong>Tip:</strong> You can check that you found the right element by highlighting it with <code>highlightElement()</code>.</p>
</div>
</div>
</div>
<p>All of these work:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href=""></a>remote_driver<span class="sc">$</span><span class="fu">findElement</span>(<span class="st">"link text"</span>, <span class="st">"Contributors"</span>)<span class="sc">$</span><span class="fu">clickElement</span>()</span>
<span id="cb8-2"><a href=""></a></span>
<span id="cb8-3"><a href=""></a>remote_driver<span class="sc">$</span><span class="fu">findElement</span>(<span class="st">"partial link text"</span>, <span class="st">"Contributors"</span>)<span class="sc">$</span><span class="fu">clickElement</span>()</span>
<span id="cb8-4"><a href=""></a></span>
<span id="cb8-5"><a href=""></a>remote_driver<span class="sc">$</span><span class="fu">findElement</span>(</span>
<span id="cb8-6"><a href=""></a>  <span class="st">"xpath"</span>,</span>
<span id="cb8-7"><a href=""></a>  <span class="st">"/html/body/div/div[1]/div[1]/div/div[1]/ul/li[3]/a"</span></span>
<span id="cb8-8"><a href=""></a>)<span class="sc">$</span><span class="fu">clickElement</span>()</span>
<span id="cb8-9"><a href=""></a></span>
<span id="cb8-10"><a href=""></a>remote_driver<span class="sc">$</span><span class="fu">findElement</span>(</span>
<span id="cb8-11"><a href=""></a>  <span class="st">"css selector"</span>,</span>
<span id="cb8-12"><a href=""></a>  <span class="st">"div.col-xs-6:nth-child(1) &gt; ul:nth-child(6) &gt; li:nth-child(3) &gt; a:nth-child(1)"</span></span>
<span id="cb8-13"><a href=""></a>)<span class="sc">$</span><span class="fu">clickElement</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section class="slide level2">

<p>We are now on the right page!</p>

<img data-src="img/contributors.png" class="r-stretch"></section>
<section class="slide level2">

<p><br><br></p>
<p>Last step: obtain the HTML of the page.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href=""></a>remote_driver<span class="sc">$</span><span class="fu">getPageSource</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><br></p>
<div class="fragment">
<p>To read it with the package <code>rvest</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href=""></a>x <span class="ot">&lt;-</span> remote_driver<span class="sc">$</span><span class="fu">getPageSource</span>()[[<span class="dv">1</span>]]</span>
<span id="cb10-2"><a href=""></a>rvest<span class="sc">::</span><span class="fu">read_html</span>(x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</section>
<section id="section" class="slide level2">
<h2></h2>
<p><br></p>
<p>Do we read the HTML and extract the information in the same script?</p>
</section>
<section id="contributors-last-step" class="slide level2">
<h2></h2>
<p><br></p>
<p>Do we read the HTML code and extract the information in the same script?</p>
<p><br></p>
<p><strong>No!</strong></p>
<p>Instead, we save the HTML in an external file, and we will be able to access it in another script (and offline) to manipulate it as we want.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href=""></a><span class="fu">print</span>(x)</span>
<span id="cb11-2"><a href=""></a><span class="fu">write</span>(x, <span class="at">file =</span> <span class="st">"contributors.html"</span>)</span>
<span id="cb11-3"><a href=""></a><span class="co"># Later and in another script</span></span>
<span id="cb11-4"><a href=""></a>rvest<span class="sc">::</span><span class="fu">read_html</span>(<span class="st">"contributors.html"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><br></p>
<p>Click <a href="#/contributors-results">here</a> to see the results.</p>

<aside><div>
<p>Although, in this case, it would be ok to treat it directly in the same script because it’s a single page.</p>
</div></aside></section>
<section class="slide level2">

<p><br><br></p>
<p>The previous example was not a <em>dynamic</em> page: we could have used the link to the page and apply webscraping methods for static webpages.</p>
<p><br></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href=""></a>rvest<span class="sc">::</span><span class="fu">read_html</span>(<span class="st">"https://www.r-project.org/contributors.html"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="fragment">
<p><br></p>
<p>Let’s now dive into a more complex example, where RSelenium is the only way to obtain the data.</p>
</div>
</section></section>
<section>
<section id="exercise-2-a-harder-real-life-example" class="title-slide slide level1 center">
<h1>Exercise 2: a harder &amp; real-life example</h1>

</section>
<section id="before-using-rselenium" class="slide level2">
<h2>Before using RSelenium</h2>
<p><br></p>
<p>Using Selenium is <strong>slower</strong> than using “classic” scraping methods, so it’s important to check all possibilities before using it.</p>
<p><br></p>
<div class="fragment">
<p>Use Selenium if:</p>
<ul>
<li><p>the HTML you want is not directly accessible, i.e needs some interactions (clicking on a button, connect to a website…),</p></li>
<li><p>the URL doesn’t change with the inputs,</p></li>
<li><p>you can’t access the data directly in the “network” tab of the console and you can’t reproduce the <code>POST</code> request.</p></li>
</ul>
</div>
</section>
<section id="example-sao-paulo-immigration-museum" class="slide level2">
<h2>Example: Sao Paulo immigration museum</h2>
<p><br></p>
<p><a href="https://www.acervodigital.museudaimigracao.org.br/livros.php" class="external" target="_blank">Open website</a></p>
<p><br></p>
<p>Steps:</p>
<ol type="1">
<li>list all interactions we need to do</li>
<li>check that we need Selenium</li>
<li>make an example</li>
<li>generalize and polish the code</li>
</ol>
</section>
<section id="list-all-interactions" class="slide level2">
<h2>List all interactions</h2>
<p><br><br></p>
<ol type="1">
<li>Open the website</li>
<li>Enter “PORTUGUESA” in the input box</li>
<li>Wait a bit for the page to load</li>
<li>Open every modal “Ver Mais”</li>
</ol>
</section>
<section id="check-that-we-need-selenium" class="slide level2">
<h2>Check that we need Selenium</h2>
<p><br></p>
<ol type="1">
<li>Is there an API?</li>
</ol>
<div class="fragment fade-in" data-fragment-index="1">
<div class="fragment highlight-current-blue" data-fragment-index="1">
<p>Not that I know of (and let’s assume that there isn’t one).</p>
</div>
</div>
<ol start="2" type="1">
<li>Does the URL change when we enter inputs or click somewhere?</li>
</ol>
<div class="fragment fade-in" data-fragment-index="2">
<div class="fragment highlight-current-blue" data-fragment-index="2">
<p>No.</p>
</div>
</div>
<ol start="3" type="1">
<li>Can we get the data through the “Network” tab?</li>
</ol>
<div class="fragment fade-in" data-fragment-index="3">
<div class="fragment highlight-current-blue" data-fragment-index="3">
<p>Not really and we still need RSelenium to change pages (and this is just training anyway).</p>
</div>
</div>
</section>
<section id="make-an-example" class="slide level2" data-auto-animate="true">
<h2 data-id="quarto-animate-title">Make an example</h2>
<p>Initiate the remote driver and go to the website:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode numberSource r number-lines code-with-copy" data-id="quarto-animate-code"><code class="sourceCode r hljs"><span id="cb13-1" class="hljs-ln-code"><a href=""></a><span class="fu">library</span>(RSelenium)</span>
<span id="cb13-2" class="hljs-ln-code"><a href=""></a></span>
<span id="cb13-3" class="hljs-ln-code"><a href=""></a>link <span class="ot">&lt;-</span> <span class="st">"https://www.acervodigital.museudaimigracao.org.br/livros.php"</span></span>
<span id="cb13-4" class="hljs-ln-code"><a href=""></a></span>
<span id="cb13-5" class="hljs-ln-code"><a href=""></a><span class="co"># Automatically go the website</span></span>
<span id="cb13-6" class="hljs-ln-code"><a href=""></a>driver <span class="ot">&lt;-</span> <span class="fu">rsDriver</span>(</span>
<span id="cb13-7" class="hljs-ln-code"><a href=""></a>  <span class="at">browser =</span> <span class="st">"firefox"</span>,</span>
<span id="cb13-8" class="hljs-ln-code"><a href=""></a>  <span class="at">chromever =</span> <span class="cn">NULL</span>,</span>
<span id="cb13-9" class="hljs-ln-code"><a href=""></a>  <span class="co"># Needed since the certificate expired</span></span>
<span id="cb13-10" class="hljs-ln-code"><a href=""></a>  <span class="at">extraCapabilities =</span> <span class="fu">list</span>(<span class="at">acceptInsecureCerts =</span> <span class="cn">TRUE</span>)</span>
<span id="cb13-11" class="hljs-ln-code"><a href=""></a>)</span>
<span id="cb13-12" class="hljs-ln-code"><a href=""></a>remote_driver <span class="ot">&lt;-</span> driver[[<span class="st">"client"</span>]]</span>
<span id="cb13-13" class="hljs-ln-code"><a href=""></a>remote_driver<span class="sc">$</span><span class="fu">navigate</span>(link)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="make-an-example-1" class="slide level2" data-auto-animate="true">
<h2 data-id="quarto-animate-title">Make an example</h2>
<p>Fill the field “NACIONALIDADE”:</p>
<div class="sourceCode" id="cb14" data-code-line-numbers="15-18"><pre class="sourceCode numberSource r number-lines code-with-copy" data-id="quarto-animate-code"><code class="sourceCode r hljs"><span id="cb14-1" class="hljs-ln-code"><a href=""></a><span class="fu">library</span>(RSelenium)</span>
<span id="cb14-2" class="hljs-ln-code"><a href=""></a></span>
<span id="cb14-3" class="hljs-ln-code"><a href=""></a>link <span class="ot">&lt;-</span> <span class="st">"https://www.acervodigital.museudaimigracao.org.br/livros.php"</span></span>
<span id="cb14-4" class="hljs-ln-code"><a href=""></a></span>
<span id="cb14-5" class="hljs-ln-code"><a href=""></a><span class="co"># Automatically go the website</span></span>
<span id="cb14-6" class="hljs-ln-code"><a href=""></a>driver <span class="ot">&lt;-</span> <span class="fu">rsDriver</span>(</span>
<span id="cb14-7" class="hljs-ln-code"><a href=""></a>  <span class="at">browser =</span> <span class="st">"firefox"</span>,</span>
<span id="cb14-8" class="hljs-ln-code"><a href=""></a>  <span class="at">chromever =</span> <span class="cn">NULL</span>,</span>
<span id="cb14-9" class="hljs-ln-code"><a href=""></a>  <span class="co"># Needed since the certificate expired</span></span>
<span id="cb14-10" class="hljs-ln-code"><a href=""></a>  <span class="at">extraCapabilities =</span> <span class="fu">list</span>(<span class="at">acceptInsecureCerts =</span> <span class="cn">TRUE</span>)</span>
<span id="cb14-11" class="hljs-ln-code"><a href=""></a>)</span>
<span id="cb14-12" class="hljs-ln-code"><a href=""></a>remote_driver <span class="ot">&lt;-</span> driver[[<span class="st">"client"</span>]]</span>
<span id="cb14-13" class="hljs-ln-code"><a href=""></a>remote_driver<span class="sc">$</span><span class="fu">navigate</span>(link)</span>
<span id="cb14-14" class="hljs-ln-code"><a href=""></a></span>
<span id="cb14-15" class="hljs-ln-code"><a href=""></a><span class="co"># Fill the nationality field and click on "Validate"</span></span>
<span id="cb14-16" class="hljs-ln-code"><a href=""></a>remote_driver<span class="sc">$</span></span>
<span id="cb14-17" class="hljs-ln-code"><a href=""></a>  <span class="fu">findElement</span>(<span class="at">using =</span> <span class="st">"id"</span>, <span class="at">value =</span> <span class="st">"nacionalidade"</span>)<span class="sc">$</span></span>
<span id="cb14-18" class="hljs-ln-code"><a href=""></a>  <span class="fu">sendKeysToElement</span>(<span class="fu">list</span>(<span class="st">"PORTUGUESA"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="make-an-example-2" class="slide level2" data-auto-animate="true">
<h2 data-id="quarto-animate-title">Make an example</h2>
<p>Find the button “Pesquisar” and click it:</p>
<div class="sourceCode" id="cb15" data-code-line-numbers="20-23"><pre class="sourceCode numberSource r number-lines code-with-copy" data-id="quarto-animate-code"><code class="sourceCode r hljs"><span id="cb15-1" class="hljs-ln-code"><a href=""></a><span class="fu">library</span>(RSelenium)</span>
<span id="cb15-2" class="hljs-ln-code"><a href=""></a></span>
<span id="cb15-3" class="hljs-ln-code"><a href=""></a>link <span class="ot">&lt;-</span> <span class="st">"https://www.acervodigital.museudaimigracao.org.br/livros.php"</span></span>
<span id="cb15-4" class="hljs-ln-code"><a href=""></a></span>
<span id="cb15-5" class="hljs-ln-code"><a href=""></a><span class="co"># Automatically go the website</span></span>
<span id="cb15-6" class="hljs-ln-code"><a href=""></a>driver <span class="ot">&lt;-</span> <span class="fu">rsDriver</span>(</span>
<span id="cb15-7" class="hljs-ln-code"><a href=""></a>  <span class="at">browser =</span> <span class="st">"firefox"</span>,</span>
<span id="cb15-8" class="hljs-ln-code"><a href=""></a>  <span class="at">chromever =</span> <span class="cn">NULL</span>,</span>
<span id="cb15-9" class="hljs-ln-code"><a href=""></a>  <span class="co"># Needed since the certificate expired</span></span>
<span id="cb15-10" class="hljs-ln-code"><a href=""></a>  <span class="at">extraCapabilities =</span> <span class="fu">list</span>(<span class="at">acceptInsecureCerts =</span> <span class="cn">TRUE</span>)</span>
<span id="cb15-11" class="hljs-ln-code"><a href=""></a>)</span>
<span id="cb15-12" class="hljs-ln-code"><a href=""></a>remote_driver <span class="ot">&lt;-</span> driver[[<span class="st">"client"</span>]]</span>
<span id="cb15-13" class="hljs-ln-code"><a href=""></a>remote_driver<span class="sc">$</span><span class="fu">navigate</span>(link)</span>
<span id="cb15-14" class="hljs-ln-code"><a href=""></a></span>
<span id="cb15-15" class="hljs-ln-code"><a href=""></a><span class="co"># Fill the nationality field and click on "Validate"</span></span>
<span id="cb15-16" class="hljs-ln-code"><a href=""></a>remote_driver<span class="sc">$</span></span>
<span id="cb15-17" class="hljs-ln-code"><a href=""></a>  <span class="fu">findElement</span>(<span class="at">using =</span> <span class="st">"id"</span>, <span class="at">value =</span> <span class="st">"nacionalidade"</span>)<span class="sc">$</span></span>
<span id="cb15-18" class="hljs-ln-code"><a href=""></a>  <span class="fu">sendKeysToElement</span>(<span class="fu">list</span>(<span class="st">"PORTUGUESA"</span>))</span>
<span id="cb15-19" class="hljs-ln-code"><a href=""></a></span>
<span id="cb15-20" class="hljs-ln-code"><a href=""></a><span class="co"># Find the button "Pesquisar" and click it</span></span>
<span id="cb15-21" class="hljs-ln-code"><a href=""></a>remote_driver<span class="sc">$</span></span>
<span id="cb15-22" class="hljs-ln-code"><a href=""></a>  <span class="fu">findElement</span>(<span class="at">using =</span> <span class="st">'name'</span>, <span class="at">value =</span> <span class="st">"Reset2"</span>)<span class="sc">$</span></span>
<span id="cb15-23" class="hljs-ln-code"><a href=""></a>  <span class="fu">clickElement</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="make-an-example-3" class="slide level2" data-auto-animate="true">
<h2 data-id="quarto-animate-title">Make an example</h2>
<p>Find the button “Ver Mais” and click it:</p>
<div class="sourceCode" id="cb16" data-code-line-numbers="25-28"><pre class="sourceCode numberSource r number-lines code-with-copy" data-id="quarto-animate-code"><code class="sourceCode r hljs"><span id="cb16-1" class="hljs-ln-code"><a href=""></a><span class="fu">library</span>(RSelenium)</span>
<span id="cb16-2" class="hljs-ln-code"><a href=""></a></span>
<span id="cb16-3" class="hljs-ln-code"><a href=""></a>link <span class="ot">&lt;-</span> <span class="st">"https://www.acervodigital.museudaimigracao.org.br/livros.php"</span></span>
<span id="cb16-4" class="hljs-ln-code"><a href=""></a></span>
<span id="cb16-5" class="hljs-ln-code"><a href=""></a><span class="co"># Automatically go the website</span></span>
<span id="cb16-6" class="hljs-ln-code"><a href=""></a>driver <span class="ot">&lt;-</span> <span class="fu">rsDriver</span>(</span>
<span id="cb16-7" class="hljs-ln-code"><a href=""></a>  <span class="at">browser =</span> <span class="st">"firefox"</span>,</span>
<span id="cb16-8" class="hljs-ln-code"><a href=""></a>  <span class="at">chromever =</span> <span class="cn">NULL</span>,</span>
<span id="cb16-9" class="hljs-ln-code"><a href=""></a>  <span class="co"># Needed since the certificate expired</span></span>
<span id="cb16-10" class="hljs-ln-code"><a href=""></a>  <span class="at">extraCapabilities =</span> <span class="fu">list</span>(<span class="at">acceptInsecureCerts =</span> <span class="cn">TRUE</span>)</span>
<span id="cb16-11" class="hljs-ln-code"><a href=""></a>)</span>
<span id="cb16-12" class="hljs-ln-code"><a href=""></a>remote_driver <span class="ot">&lt;-</span> driver[[<span class="st">"client"</span>]]</span>
<span id="cb16-13" class="hljs-ln-code"><a href=""></a>remote_driver<span class="sc">$</span><span class="fu">navigate</span>(link)</span>
<span id="cb16-14" class="hljs-ln-code"><a href=""></a></span>
<span id="cb16-15" class="hljs-ln-code"><a href=""></a><span class="co"># Fill the nationality field and click on "Validate"</span></span>
<span id="cb16-16" class="hljs-ln-code"><a href=""></a>remote_driver<span class="sc">$</span></span>
<span id="cb16-17" class="hljs-ln-code"><a href=""></a>  <span class="fu">findElement</span>(<span class="at">using =</span> <span class="st">"id"</span>, <span class="at">value =</span> <span class="st">"nacionalidade"</span>)<span class="sc">$</span></span>
<span id="cb16-18" class="hljs-ln-code"><a href=""></a>  <span class="fu">sendKeysToElement</span>(<span class="fu">list</span>(<span class="st">"PORTUGUESA"</span>))</span>
<span id="cb16-19" class="hljs-ln-code"><a href=""></a></span>
<span id="cb16-20" class="hljs-ln-code"><a href=""></a><span class="co"># Find the button "Pesquisar" and click it</span></span>
<span id="cb16-21" class="hljs-ln-code"><a href=""></a>remote_driver<span class="sc">$</span></span>
<span id="cb16-22" class="hljs-ln-code"><a href=""></a>  <span class="fu">findElement</span>(<span class="at">using =</span> <span class="st">'name'</span>, <span class="at">value =</span> <span class="st">"Reset2"</span>)<span class="sc">$</span></span>
<span id="cb16-23" class="hljs-ln-code"><a href=""></a>  <span class="fu">clickElement</span>()</span>
<span id="cb16-24" class="hljs-ln-code"><a href=""></a></span>
<span id="cb16-25" class="hljs-ln-code"><a href=""></a><span class="co"># Find the button "Ver Mais" and click it</span></span>
<span id="cb16-26" class="hljs-ln-code"><a href=""></a>remote_driver<span class="sc">$</span></span>
<span id="cb16-27" class="hljs-ln-code"><a href=""></a>  <span class="fu">findElement</span>(<span class="at">using =</span> <span class="st">'id'</span>, <span class="at">value =</span> <span class="st">"link_ver_detalhe"</span>)<span class="sc">$</span></span>
<span id="cb16-28" class="hljs-ln-code"><a href=""></a>  <span class="fu">clickElement</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="make-an-example-4" class="slide level2" data-auto-animate="true">
<h2 data-id="quarto-animate-title">Make an example</h2>
<p>Get the HTML that is displayed:</p>
<div class="sourceCode" id="cb17" data-code-line-numbers="30-31"><pre class="sourceCode numberSource r number-lines code-with-copy" data-id="quarto-animate-code"><code class="sourceCode r hljs"><span id="cb17-1" class="hljs-ln-code"><a href=""></a><span class="fu">library</span>(RSelenium)</span>
<span id="cb17-2" class="hljs-ln-code"><a href=""></a></span>
<span id="cb17-3" class="hljs-ln-code"><a href=""></a>link <span class="ot">&lt;-</span> <span class="st">"http://www.inci.org.br/acervodigital/livros.php"</span></span>
<span id="cb17-4" class="hljs-ln-code"><a href=""></a></span>
<span id="cb17-5" class="hljs-ln-code"><a href=""></a><span class="co"># Automatically go the website</span></span>
<span id="cb17-6" class="hljs-ln-code"><a href=""></a>driver <span class="ot">&lt;-</span> <span class="fu">rsDriver</span>(</span>
<span id="cb17-7" class="hljs-ln-code"><a href=""></a>  <span class="at">browser =</span> <span class="st">"firefox"</span>,</span>
<span id="cb17-8" class="hljs-ln-code"><a href=""></a>  <span class="at">chromever =</span> <span class="cn">NULL</span>,</span>
<span id="cb17-9" class="hljs-ln-code"><a href=""></a>  <span class="co"># Needed since the certificate expired</span></span>
<span id="cb17-10" class="hljs-ln-code"><a href=""></a>  <span class="at">extraCapabilities =</span> <span class="fu">list</span>(<span class="at">acceptInsecureCerts =</span> <span class="cn">TRUE</span>)</span>
<span id="cb17-11" class="hljs-ln-code"><a href=""></a>)</span>
<span id="cb17-12" class="hljs-ln-code"><a href=""></a>remote_driver <span class="ot">&lt;-</span> driver[[<span class="st">"client"</span>]]</span>
<span id="cb17-13" class="hljs-ln-code"><a href=""></a>remote_driver<span class="sc">$</span><span class="fu">navigate</span>(link)</span>
<span id="cb17-14" class="hljs-ln-code"><a href=""></a></span>
<span id="cb17-15" class="hljs-ln-code"><a href=""></a><span class="co"># Fill the nationality field and click on "Validate"</span></span>
<span id="cb17-16" class="hljs-ln-code"><a href=""></a>remote_driver<span class="sc">$</span></span>
<span id="cb17-17" class="hljs-ln-code"><a href=""></a>  <span class="fu">findElement</span>(<span class="at">using =</span> <span class="st">"id"</span>, <span class="at">value =</span> <span class="st">"nacionalidade"</span>)<span class="sc">$</span></span>
<span id="cb17-18" class="hljs-ln-code"><a href=""></a>  <span class="fu">sendKeysToElement</span>(<span class="fu">list</span>(<span class="st">"PORTUGUESA"</span>))</span>
<span id="cb17-19" class="hljs-ln-code"><a href=""></a></span>
<span id="cb17-20" class="hljs-ln-code"><a href=""></a><span class="co"># Find the button "Pesquisar" and click it</span></span>
<span id="cb17-21" class="hljs-ln-code"><a href=""></a>remote_driver<span class="sc">$</span></span>
<span id="cb17-22" class="hljs-ln-code"><a href=""></a>  <span class="fu">findElement</span>(<span class="at">using =</span> <span class="st">'name'</span>, <span class="at">value =</span> <span class="st">"Reset2"</span>)<span class="sc">$</span></span>
<span id="cb17-23" class="hljs-ln-code"><a href=""></a>  <span class="fu">clickElement</span>()</span>
<span id="cb17-24" class="hljs-ln-code"><a href=""></a></span>
<span id="cb17-25" class="hljs-ln-code"><a href=""></a><span class="co"># Find the button "Ver Mais" and click it</span></span>
<span id="cb17-26" class="hljs-ln-code"><a href=""></a>remote_driver<span class="sc">$</span></span>
<span id="cb17-27" class="hljs-ln-code"><a href=""></a>  <span class="fu">findElement</span>(<span class="at">using =</span> <span class="st">'id'</span>, <span class="at">value =</span> <span class="st">"link_ver_detalhe"</span>)<span class="sc">$</span></span>
<span id="cb17-28" class="hljs-ln-code"><a href=""></a>  <span class="fu">clickElement</span>()</span>
<span id="cb17-29" class="hljs-ln-code"><a href=""></a></span>
<span id="cb17-30" class="hljs-ln-code"><a href=""></a><span class="co"># Get the HTML that is displayed in the modal</span></span>
<span id="cb17-31" class="hljs-ln-code"><a href=""></a>x <span class="ot">&lt;-</span> remote_driver<span class="sc">$</span><span class="fu">getPageSource</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="make-an-example-5" class="slide level2" data-auto-animate="true">
<h2 data-id="quarto-animate-title">Make an example</h2>
<p>Exit the modal by pressing “Escape”:</p>
<div class="sourceCode" id="cb18" data-code-line-numbers="33-36"><pre class="sourceCode numberSource r number-lines code-with-copy" data-id="quarto-animate-code"><code class="sourceCode r hljs"><span id="cb18-1" class="hljs-ln-code"><a href=""></a><span class="fu">library</span>(RSelenium)</span>
<span id="cb18-2" class="hljs-ln-code"><a href=""></a></span>
<span id="cb18-3" class="hljs-ln-code"><a href=""></a>link <span class="ot">&lt;-</span> <span class="st">"http://www.inci.org.br/acervodigital/livros.php"</span></span>
<span id="cb18-4" class="hljs-ln-code"><a href=""></a></span>
<span id="cb18-5" class="hljs-ln-code"><a href=""></a><span class="co"># Automatically go the website</span></span>
<span id="cb18-6" class="hljs-ln-code"><a href=""></a>driver <span class="ot">&lt;-</span> <span class="fu">rsDriver</span>(</span>
<span id="cb18-7" class="hljs-ln-code"><a href=""></a>  <span class="at">browser =</span> <span class="st">"firefox"</span>,</span>
<span id="cb18-8" class="hljs-ln-code"><a href=""></a>  <span class="at">chromever =</span> <span class="cn">NULL</span>,</span>
<span id="cb18-9" class="hljs-ln-code"><a href=""></a>  <span class="co"># Needed since the certificate expired</span></span>
<span id="cb18-10" class="hljs-ln-code"><a href=""></a>  <span class="at">extraCapabilities =</span> <span class="fu">list</span>(<span class="at">acceptInsecureCerts =</span> <span class="cn">TRUE</span>)</span>
<span id="cb18-11" class="hljs-ln-code"><a href=""></a>)</span>
<span id="cb18-12" class="hljs-ln-code"><a href=""></a>remote_driver <span class="ot">&lt;-</span> driver[[<span class="st">"client"</span>]]</span>
<span id="cb18-13" class="hljs-ln-code"><a href=""></a>remote_driver<span class="sc">$</span><span class="fu">navigate</span>(link)</span>
<span id="cb18-14" class="hljs-ln-code"><a href=""></a></span>
<span id="cb18-15" class="hljs-ln-code"><a href=""></a><span class="co"># Fill the nationality field and click on "Validate"</span></span>
<span id="cb18-16" class="hljs-ln-code"><a href=""></a>remote_driver<span class="sc">$</span></span>
<span id="cb18-17" class="hljs-ln-code"><a href=""></a>  <span class="fu">findElement</span>(<span class="at">using =</span> <span class="st">"id"</span>, <span class="at">value =</span> <span class="st">"nacionalidade"</span>)<span class="sc">$</span></span>
<span id="cb18-18" class="hljs-ln-code"><a href=""></a>  <span class="fu">sendKeysToElement</span>(<span class="fu">list</span>(<span class="st">"PORTUGUESA"</span>))</span>
<span id="cb18-19" class="hljs-ln-code"><a href=""></a></span>
<span id="cb18-20" class="hljs-ln-code"><a href=""></a><span class="co"># Find the button "Pesquisar" and click it</span></span>
<span id="cb18-21" class="hljs-ln-code"><a href=""></a>remote_driver<span class="sc">$</span></span>
<span id="cb18-22" class="hljs-ln-code"><a href=""></a>  <span class="fu">findElement</span>(<span class="at">using =</span> <span class="st">'name'</span>, <span class="at">value =</span> <span class="st">"Reset2"</span>)<span class="sc">$</span></span>
<span id="cb18-23" class="hljs-ln-code"><a href=""></a>  <span class="fu">clickElement</span>()</span>
<span id="cb18-24" class="hljs-ln-code"><a href=""></a></span>
<span id="cb18-25" class="hljs-ln-code"><a href=""></a><span class="co"># Find the button "Ver Mais" and click it</span></span>
<span id="cb18-26" class="hljs-ln-code"><a href=""></a>remote_driver<span class="sc">$</span></span>
<span id="cb18-27" class="hljs-ln-code"><a href=""></a>  <span class="fu">findElement</span>(<span class="at">using =</span> <span class="st">'id'</span>, <span class="at">value =</span> <span class="st">"link_ver_detalhe"</span>)<span class="sc">$</span></span>
<span id="cb18-28" class="hljs-ln-code"><a href=""></a>  <span class="fu">clickElement</span>()</span>
<span id="cb18-29" class="hljs-ln-code"><a href=""></a></span>
<span id="cb18-30" class="hljs-ln-code"><a href=""></a><span class="co"># Get the HTML that is displayed in the modal</span></span>
<span id="cb18-31" class="hljs-ln-code"><a href=""></a>x <span class="ot">&lt;-</span> remote_driver<span class="sc">$</span><span class="fu">getPageSource</span>()</span>
<span id="cb18-32" class="hljs-ln-code"><a href=""></a></span>
<span id="cb18-33" class="hljs-ln-code"><a href=""></a><span class="co"># Exit the modal by pressing "Escape"</span></span>
<span id="cb18-34" class="hljs-ln-code"><a href=""></a>remote_driver<span class="sc">$</span></span>
<span id="cb18-35" class="hljs-ln-code"><a href=""></a>  <span class="fu">findElement</span>(<span class="at">using =</span> <span class="st">"xpath"</span>, <span class="at">value =</span> <span class="st">"/html/body"</span>)<span class="sc">$</span></span>
<span id="cb18-36" class="hljs-ln-code"><a href=""></a>  <span class="fu">sendKeysToElement</span>(<span class="fu">list</span>(<span class="at">key =</span> <span class="st">"escape"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="problem" class="slide level2">
<h2>Problem</h2>
<p><br><br></p>
<p>We got the content of the first modal, that’s great!</p>
<p><br></p>
<p>Now we just need to replicate this for the other modals of the page.</p>
<p><br></p>
<div class="fragment">
<p><strong>How can we distinguish one button “Ver Mais” from another?</strong></p>
</div>
</section>
<section id="problem-1" class="slide level2">
<h2>Problem</h2>
<p><br></p>
<p>To find the button “Ver Mais”, we used the following code:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href=""></a>remote_driver<span class="sc">$</span><span class="fu">findElement</span>(</span>
<span id="cb19-2"><a href=""></a>  <span class="at">using =</span> <span class="st">'id'</span>,</span>
<span id="cb19-3"><a href=""></a>  <span class="at">value =</span> <span class="st">"link_ver_detalhe"</span></span>
<span id="cb19-4"><a href=""></a>)<span class="sc">$</span><span class="fu">clickElement</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><br></p>
<p>But all buttons share the same <code>id</code>, so this code only selects the first button, not the others.</p>
</section>
<section id="solution" class="slide level2">
<h2>Solution</h2>
<p><br></p>
<p>Use <code>findElements()</code> (and not <code>findElement()</code>).</p>
<p><br></p>
<p>This returns a list of elements, and we can then apply some function on each of them in a loop:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href=""></a><span class="co"># Make the list of elements</span></span>
<span id="cb20-2"><a href=""></a>buttons <span class="ot">&lt;-</span> remote_driver<span class="sc">$</span><span class="fu">findElements</span>(<span class="at">using =</span> <span class="st">'id'</span>, <span class="at">value =</span> <span class="st">"link_ver_detalhe"</span>)</span>
<span id="cb20-3"><a href=""></a></span>
<span id="cb20-4"><a href=""></a><span class="co"># Highlight each button one by one</span></span>
<span id="cb20-5"><a href=""></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_along</span>(buttons)) {</span>
<span id="cb20-6"><a href=""></a>  buttons[[i]]<span class="sc">$</span><span class="fu">highlightElement</span>()</span>
<span id="cb20-7"><a href=""></a>  <span class="fu">Sys.sleep</span>(<span class="dv">1</span>)</span>
<span id="cb20-8"><a href=""></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="loop-through-modals" class="slide level2">
<h2>Loop through modals</h2>
<p><br></p>
<p>Now that we have a way to open each modal, we can make a loop to get the HTML for each one:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href=""></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_along</span>(buttons)) {</span>
<span id="cb21-2"><a href=""></a>  <span class="co"># open the modal</span></span>
<span id="cb21-3"><a href=""></a>  buttons[[i]]<span class="sc">$</span><span class="fu">clickElement</span>()</span>
<span id="cb21-4"><a href=""></a>  <span class="fu">Sys.sleep</span>(<span class="fl">0.5</span>)</span>
<span id="cb21-5"><a href=""></a></span>
<span id="cb21-6"><a href=""></a>  <span class="co"># get the HTML and save it</span></span>
<span id="cb21-7"><a href=""></a>  tmp <span class="ot">&lt;-</span> remote_driver<span class="sc">$</span><span class="fu">getPageSource</span>()[[<span class="dv">1</span>]]</span>
<span id="cb21-8"><a href=""></a>  <span class="fu">write</span>(tmp, <span class="at">file =</span> <span class="fu">paste0</span>(<span class="st">"data/modals/modal-"</span>, i, <span class="st">".html"</span>))</span>
<span id="cb21-9"><a href=""></a></span>
<span id="cb21-10"><a href=""></a>  <span class="co"># quit the modal (by pressing "Escape")</span></span>
<span id="cb21-11"><a href=""></a>  remote_driver<span class="sc">$</span><span class="fu">findElement</span>(</span>
<span id="cb21-12"><a href=""></a>    <span class="at">using =</span> <span class="st">"xpath"</span>,</span>
<span id="cb21-13"><a href=""></a>    <span class="at">value =</span> <span class="st">"/html/body"</span></span>
<span id="cb21-14"><a href=""></a>  )<span class="sc">$</span><span class="fu">sendKeysToElement</span>(<span class="fu">list</span>(<span class="at">key =</span> <span class="st">"escape"</span>))</span>
<span id="cb21-15"><a href=""></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="generalize-for-each-page" class="slide level2">
<h2>Generalize for each page</h2>
<p><br></p>
<p>Find the button to go to the next page:</p>
<p><br></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href=""></a>remote_driver<span class="sc">$</span><span class="fu">findElement</span>(<span class="st">"id"</span>, <span class="st">"2"</span>)<span class="sc">$</span><span class="fu">highlightElement</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="nested-loops" class="slide level2">
<h2>Nested loops</h2>
<p><br></p>
<p>We know how to:</p>
<ul>
<li>open the website</li>
<li>search for the right inputs</li>
<li>open each modal and get its content</li>
<li>go to the next page</li>
</ul>
<div class="fragment">
<p><br></p>
<p>Next step: compile all of this and make nested loops!</p>
</div>
</section>
<section id="section-1" class="slide level2" data-auto-animate="true">
<h2 data-id="quarto-animate-title"></h2>
<p>How many pages? <strong>2348</strong> (but just put 2-3 to avoid too many requests)</p>
<p><br></p>
<p>Pseudo-code:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode numberSource r number-lines code-with-copy" data-id="quarto-animate-code"><code class="sourceCode r hljs"><span id="cb23-1" class="hljs-ln-code"><a href=""></a><span class="cf">for</span> (page_index <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>) {</span>
<span id="cb23-2" class="hljs-ln-code"><a href=""></a>  <span class="co"># Find all buttons "Ver Mais" on the page</span></span>
<span id="cb23-3" class="hljs-ln-code"><a href=""></a></span>
<span id="cb23-4" class="hljs-ln-code"><a href=""></a>  <span class="cf">for</span> (modal_index <span class="cf">in</span> <span class="fu">seq_along</span>(buttons)) {</span>
<span id="cb23-5" class="hljs-ln-code"><a href=""></a>    <span class="co"># open modal</span></span>
<span id="cb23-6" class="hljs-ln-code"><a href=""></a>    <span class="co"># get HTML and save it in an external file</span></span>
<span id="cb23-7" class="hljs-ln-code"><a href=""></a>    <span class="co"># leave modal</span></span>
<span id="cb23-8" class="hljs-ln-code"><a href=""></a>  }</span>
<span id="cb23-9" class="hljs-ln-code"><a href=""></a></span>
<span id="cb23-10" class="hljs-ln-code"><a href=""></a>  <span class="co"># Once all modals of a page have been scraped, go to the next page</span></span>
<span id="cb23-11" class="hljs-ln-code"><a href=""></a>  <span class="co"># (except if we're on the last page)</span></span>
<span id="cb23-12" class="hljs-ln-code"><a href=""></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="section-2" class="slide level2" data-auto-animate="true">
<h2 data-id="quarto-animate-title"></h2>
<p>How many pages? <strong>2348</strong> (but just put 2-3 to avoid too many requests)</p>
<p><br></p>
<p>Pseudo-code:</p>
<div class="sourceCode" id="cb24" data-code-line-numbers="3-5"><pre class="sourceCode numberSource r number-lines code-with-copy" data-id="quarto-animate-code"><code class="sourceCode r hljs"><span id="cb24-1" class="hljs-ln-code"><a href=""></a><span class="cf">for</span> (page_index <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>) {</span>
<span id="cb24-2" class="hljs-ln-code"><a href=""></a></span>
<span id="cb24-3" class="hljs-ln-code"><a href=""></a>  <span class="co"># Find all buttons "Ver Mais" on the page</span></span>
<span id="cb24-4" class="hljs-ln-code"><a href=""></a>  buttons <span class="ot">&lt;-</span> remote_driver<span class="sc">$</span></span>
<span id="cb24-5" class="hljs-ln-code"><a href=""></a>    <span class="fu">findElements</span>(<span class="at">using =</span> <span class="st">'id'</span>, <span class="at">value =</span> <span class="st">"link_ver_detalhe"</span>)</span>
<span id="cb24-6" class="hljs-ln-code"><a href=""></a></span>
<span id="cb24-7" class="hljs-ln-code"><a href=""></a>  <span class="cf">for</span> (modal_index <span class="cf">in</span> <span class="fu">seq_along</span>(buttons)) {</span>
<span id="cb24-8" class="hljs-ln-code"><a href=""></a>    <span class="co"># open modal</span></span>
<span id="cb24-9" class="hljs-ln-code"><a href=""></a>    <span class="co"># get HTML and save it in an external file</span></span>
<span id="cb24-10" class="hljs-ln-code"><a href=""></a>    <span class="co"># leave modal</span></span>
<span id="cb24-11" class="hljs-ln-code"><a href=""></a>  }</span>
<span id="cb24-12" class="hljs-ln-code"><a href=""></a></span>
<span id="cb24-13" class="hljs-ln-code"><a href=""></a>  <span class="co"># Once all modals of a page have been scraped, go to the next page</span></span>
<span id="cb24-14" class="hljs-ln-code"><a href=""></a>  <span class="co"># (except if we're on the last page)</span></span>
<span id="cb24-15" class="hljs-ln-code"><a href=""></a></span>
<span id="cb24-16" class="hljs-ln-code"><a href=""></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="section-3" class="slide level2" data-auto-animate="true">
<h2 data-id="quarto-animate-title"></h2>
<p>How many pages? <strong>2348</strong> (but just put 2-3 to avoid too many requests)</p>
<p><br></p>
<p>Make the “modal loop”:</p>
<div class="sourceCode" id="cb25" data-code-line-numbers="7-22"><pre class="sourceCode numberSource r number-lines code-with-copy" data-id="quarto-animate-code"><code class="sourceCode r hljs"><span id="cb25-1" class="hljs-ln-code"><a href=""></a><span class="cf">for</span> (page_index <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>) {</span>
<span id="cb25-2" class="hljs-ln-code"><a href=""></a></span>
<span id="cb25-3" class="hljs-ln-code"><a href=""></a>  <span class="co"># Find all buttons "Ver Mais" on the page</span></span>
<span id="cb25-4" class="hljs-ln-code"><a href=""></a>  buttons <span class="ot">&lt;-</span> remote_driver<span class="sc">$</span></span>
<span id="cb25-5" class="hljs-ln-code"><a href=""></a>    <span class="fu">findElements</span>(<span class="at">using =</span> <span class="st">'id'</span>, <span class="at">value =</span> <span class="st">"link_ver_detalhe"</span>)</span>
<span id="cb25-6" class="hljs-ln-code"><a href=""></a></span>
<span id="cb25-7" class="hljs-ln-code"><a href=""></a>  <span class="cf">for</span> (modal_index <span class="cf">in</span> <span class="fu">seq_along</span>(buttons)) {</span>
<span id="cb25-8" class="hljs-ln-code"><a href=""></a>    <span class="co"># open modal</span></span>
<span id="cb25-9" class="hljs-ln-code"><a href=""></a>    buttons[[modal_index]]<span class="sc">$</span><span class="fu">clickElement</span>()</span>
<span id="cb25-10" class="hljs-ln-code"><a href=""></a></span>
<span id="cb25-11" class="hljs-ln-code"><a href=""></a>    <span class="co"># Get the HTML and save it</span></span>
<span id="cb25-12" class="hljs-ln-code"><a href=""></a>    tmp <span class="ot">&lt;-</span> remote_driver<span class="sc">$</span><span class="fu">getPageSource</span>()[[<span class="dv">1</span>]]</span>
<span id="cb25-13" class="hljs-ln-code"><a href=""></a>    <span class="fu">write</span>(tmp, <span class="at">file =</span> <span class="fu">paste0</span>(<span class="st">"data/modals/modal-"</span>, modal_index, <span class="st">".html"</span>))</span>
<span id="cb25-14" class="hljs-ln-code"><a href=""></a></span>
<span id="cb25-15" class="hljs-ln-code"><a href=""></a>    <span class="co"># Leave the modal</span></span>
<span id="cb25-16" class="hljs-ln-code"><a href=""></a>    remote_driver<span class="sc">$</span></span>
<span id="cb25-17" class="hljs-ln-code"><a href=""></a>      <span class="fu">findElement</span>(<span class="at">using =</span> <span class="st">"xpath"</span>, <span class="at">value =</span> <span class="st">"/html/body"</span>)<span class="sc">$</span></span>
<span id="cb25-18" class="hljs-ln-code"><a href=""></a>      <span class="fu">sendKeysToElement</span>(<span class="fu">list</span>(<span class="at">key =</span> <span class="st">"escape"</span>))</span>
<span id="cb25-19" class="hljs-ln-code"><a href=""></a></span>
<span id="cb25-20" class="hljs-ln-code"><a href=""></a>  }</span>
<span id="cb25-21" class="hljs-ln-code"><a href=""></a></span>
<span id="cb25-22" class="hljs-ln-code"><a href=""></a>  <span class="co"># Once all modals of a page have been scraped, go to the next page</span></span>
<span id="cb25-23" class="hljs-ln-code"><a href=""></a>  <span class="co"># (except if we're on the last page)</span></span>
<span id="cb25-24" class="hljs-ln-code"><a href=""></a></span>
<span id="cb25-25" class="hljs-ln-code"><a href=""></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="section-4" class="slide level2" data-auto-animate="true">
<h2 data-id="quarto-animate-title"></h2>
<p>How many pages? <strong>2348</strong> (but just put 2-3 to avoid too many requests)</p>
<p><br></p>
<p>Make the “page loop”:</p>
<div class="sourceCode" id="cb26" data-code-line-numbers="25-33"><pre class="sourceCode numberSource r number-lines code-with-copy" data-id="quarto-animate-code"><code class="sourceCode r hljs"><span id="cb26-1" class="hljs-ln-code"><a href=""></a><span class="cf">for</span> (page_index <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>) {</span>
<span id="cb26-2" class="hljs-ln-code"><a href=""></a></span>
<span id="cb26-3" class="hljs-ln-code"><a href=""></a>  <span class="co"># Find all buttons "Ver Mais" on the page</span></span>
<span id="cb26-4" class="hljs-ln-code"><a href=""></a>  buttons <span class="ot">&lt;-</span> remote_driver<span class="sc">$</span></span>
<span id="cb26-5" class="hljs-ln-code"><a href=""></a>    <span class="fu">findElements</span>(<span class="at">using =</span> <span class="st">'id'</span>, <span class="at">value =</span> <span class="st">"link_ver_detalhe"</span>)</span>
<span id="cb26-6" class="hljs-ln-code"><a href=""></a></span>
<span id="cb26-7" class="hljs-ln-code"><a href=""></a>  <span class="cf">for</span> (modal_index <span class="cf">in</span> <span class="fu">seq_along</span>(buttons)) {</span>
<span id="cb26-8" class="hljs-ln-code"><a href=""></a>    <span class="co"># open modal</span></span>
<span id="cb26-9" class="hljs-ln-code"><a href=""></a>    buttons[[modal_index]]<span class="sc">$</span><span class="fu">clickElement</span>()</span>
<span id="cb26-10" class="hljs-ln-code"><a href=""></a></span>
<span id="cb26-11" class="hljs-ln-code"><a href=""></a>    <span class="co"># Get the HTML and save it</span></span>
<span id="cb26-12" class="hljs-ln-code"><a href=""></a>    tmp <span class="ot">&lt;-</span> remote_driver<span class="sc">$</span><span class="fu">getPageSource</span>()[[<span class="dv">1</span>]]</span>
<span id="cb26-13" class="hljs-ln-code"><a href=""></a>    <span class="fu">write</span>(tmp, <span class="at">file =</span> <span class="fu">paste0</span>(<span class="st">"data/modals/page-"</span>, page_index,</span>
<span id="cb26-14" class="hljs-ln-code"><a href=""></a>                             <span class="st">"-modal-"</span>, modal_index, <span class="st">".html"</span>))</span>
<span id="cb26-15" class="hljs-ln-code"><a href=""></a></span>
<span id="cb26-16" class="hljs-ln-code"><a href=""></a>    <span class="co"># Leave the modal</span></span>
<span id="cb26-17" class="hljs-ln-code"><a href=""></a>    remote_driver<span class="sc">$</span></span>
<span id="cb26-18" class="hljs-ln-code"><a href=""></a>      <span class="fu">findElement</span>(<span class="at">using =</span> <span class="st">"xpath"</span>, <span class="at">value =</span> <span class="st">"/html/body"</span>)<span class="sc">$</span></span>
<span id="cb26-19" class="hljs-ln-code"><a href=""></a>      <span class="fu">sendKeysToElement</span>(<span class="fu">list</span>(<span class="at">key =</span> <span class="st">"escape"</span>))</span>
<span id="cb26-20" class="hljs-ln-code"><a href=""></a></span>
<span id="cb26-21" class="hljs-ln-code"><a href=""></a>  }</span>
<span id="cb26-22" class="hljs-ln-code"><a href=""></a></span>
<span id="cb26-23" class="hljs-ln-code"><a href=""></a>  <span class="co"># When we got all modals of one page, go to the next page (except if</span></span>
<span id="cb26-24" class="hljs-ln-code"><a href=""></a>  <span class="co"># we're on the last one)</span></span>
<span id="cb26-25" class="hljs-ln-code"><a href=""></a>  <span class="cf">if</span> (page_index <span class="sc">!=</span> <span class="dv">2348</span>) {</span>
<span id="cb26-26" class="hljs-ln-code"><a href=""></a>    <span class="co"># Give selenium a bit of time to actually find the</span></span>
<span id="cb26-27" class="hljs-ln-code"><a href=""></a>    <span class="co"># element before clicking it</span></span>
<span id="cb26-28" class="hljs-ln-code"><a href=""></a>    elem <span class="ot">&lt;-</span> remote_driver<span class="sc">$</span><span class="fu">findElement</span>(<span class="st">"id"</span>, <span class="fu">as.character</span>(page_index <span class="sc">+</span> <span class="dv">1</span>))</span>
<span id="cb26-29" class="hljs-ln-code"><a href=""></a>    <span class="fu">Sys.sleep</span>(<span class="dv">1</span>)</span>
<span id="cb26-30" class="hljs-ln-code"><a href=""></a>    elem<span class="sc">$</span><span class="fu">clickElement</span>()</span>
<span id="cb26-31" class="hljs-ln-code"><a href=""></a>  }</span>
<span id="cb26-32" class="hljs-ln-code"><a href=""></a></span>
<span id="cb26-33" class="hljs-ln-code"><a href=""></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section class="slide level2">

<p><br><br> <br><br></p>
<p>Great, let’s run everything!</p>
<p><br></p>
<div class="fragment">
<p><i class="fa-solid fa-arrow-right" aria-hidden="true"></i> &nbsp; Not so fast</p>
</div>
</section></section>
<section id="error-handling" class="title-slide slide level1 center">
<h1>Error handling</h1>

</section>

<section>
<section id="catching-errors" class="title-slide slide level1 center">
<h1>1. Catching errors</h1>

</section>
<section id="catching-errors-1" class="slide level2">
<h2>Catching errors</h2>
<p>See the <code>tryCatch()</code> slides from yesterday</p>
</section></section>
<section>
<section id="loading-times" class="title-slide slide level1 center">
<h1>2. Loading times</h1>

</section>
<section id="loading-times-1" class="slide level2">
<h2>Loading times</h2>
<p><br></p>
<p>There are a few places where we need to wait a bit:</p>
<ul>
<li>after clicking on “Pesquisar”</li>
<li>after clicking on “Ver Mais”</li>
<li>when we go to the next page</li>
</ul>
<div class="fragment">
<p><br></p>
<p>We must put some pauses between <code>RSelenium</code> actions. Otherwise it will error, e.g.&nbsp;if we try to click on a button that isn’t loaded on the page yet.</p>
</div>
<div class="fragment">
<p><br></p>
<p><i class="fa-solid fa-arrow-right" aria-hidden="true"></i> &nbsp; one solution is to use <code>Sys.sleep()</code></p>
</div>
</section>
<section id="loading-times-2" class="slide level2">
<h2>Loading times</h2>
<div class="sourceCode" id="cb27" data-code-line-numbers="11,23,35"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href=""></a><span class="cf">for</span> (page_index <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">2348</span>) {</span>
<span id="cb27-2"><a href=""></a></span>
<span id="cb27-3"><a href=""></a>  <span class="co"># Find all buttons "Ver Mais" on the page</span></span>
<span id="cb27-4"><a href=""></a>  buttons <span class="ot">&lt;-</span> remote_driver<span class="sc">$</span></span>
<span id="cb27-5"><a href=""></a>    <span class="fu">findElements</span>(<span class="at">using =</span> <span class="st">'id'</span>, <span class="at">value =</span> <span class="st">"link_ver_detalhe"</span>)</span>
<span id="cb27-6"><a href=""></a></span>
<span id="cb27-7"><a href=""></a>  <span class="cf">for</span> (modal_index <span class="cf">in</span> <span class="fu">seq_along</span>(buttons)) {</span>
<span id="cb27-8"><a href=""></a>    <span class="co"># open modal</span></span>
<span id="cb27-9"><a href=""></a>    buttons[[modal_index]]<span class="sc">$</span><span class="fu">clickElement</span>()</span>
<span id="cb27-10"><a href=""></a></span>
<span id="cb27-11"><a href=""></a>    <span class="fu">Sys.sleep</span>(<span class="fl">0.5</span>)</span>
<span id="cb27-12"><a href=""></a></span>
<span id="cb27-13"><a href=""></a>    <span class="co"># Get the HTML and save it</span></span>
<span id="cb27-14"><a href=""></a>    tmp <span class="ot">&lt;-</span> remote_driver<span class="sc">$</span><span class="fu">getPageSource</span>()[[<span class="dv">1</span>]]</span>
<span id="cb27-15"><a href=""></a>    <span class="fu">write</span>(tmp, <span class="at">file =</span> <span class="fu">paste0</span>(<span class="st">"data/modals/page-"</span>, page_index,</span>
<span id="cb27-16"><a href=""></a>                             <span class="st">"-modal-"</span>, modal_index, <span class="st">".html"</span>))</span>
<span id="cb27-17"><a href=""></a></span>
<span id="cb27-18"><a href=""></a>    <span class="co"># Leave the modal</span></span>
<span id="cb27-19"><a href=""></a>    remote_driver<span class="sc">$</span></span>
<span id="cb27-20"><a href=""></a>      <span class="fu">findElement</span>(<span class="at">using =</span> <span class="st">"xpath"</span>, <span class="at">value =</span> <span class="st">"/html/body"</span>)<span class="sc">$</span></span>
<span id="cb27-21"><a href=""></a>      <span class="fu">sendKeysToElement</span>(<span class="fu">list</span>(<span class="at">key =</span> <span class="st">"escape"</span>))</span>
<span id="cb27-22"><a href=""></a></span>
<span id="cb27-23"><a href=""></a>    <span class="fu">Sys.sleep</span>(<span class="fl">0.5</span>)</span>
<span id="cb27-24"><a href=""></a>  }</span>
<span id="cb27-25"><a href=""></a></span>
<span id="cb27-26"><a href=""></a>  <span class="co"># When we got all modals of one page, go to the next page (except if</span></span>
<span id="cb27-27"><a href=""></a>  <span class="co"># we're on the last one)</span></span>
<span id="cb27-28"><a href=""></a>  <span class="cf">if</span> (page_index <span class="sc">!=</span> <span class="dv">2348</span>) {</span>
<span id="cb27-29"><a href=""></a>    <span class="co"># Give selenium a bit of time to actually find the</span></span>
<span id="cb27-30"><a href=""></a>    <span class="co"># element before clicking it</span></span>
<span id="cb27-31"><a href=""></a>    elem <span class="ot">&lt;-</span> remote_driver<span class="sc">$</span><span class="fu">findElement</span>(<span class="st">"id"</span>, <span class="fu">as.character</span>(page_index <span class="sc">+</span> <span class="dv">1</span>))</span>
<span id="cb27-32"><a href=""></a>    <span class="fu">Sys.sleep</span>(<span class="dv">1</span>)</span>
<span id="cb27-33"><a href=""></a>    elem<span class="sc">$</span><span class="fu">clickElement</span>()</span>
<span id="cb27-34"><a href=""></a></span>
<span id="cb27-35"><a href=""></a>    <span class="fu">Sys.sleep</span>(<span class="dv">3</span>)</span>
<span id="cb27-36"><a href=""></a>  }</span>
<span id="cb27-37"><a href=""></a></span>
<span id="cb27-38"><a href=""></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="loading-times-3" class="slide level2">
<h2>Loading times</h2>
<p><br></p>
<p>However, using <code>Sys.sleep()</code> is not perfect because we put arbitrary timing, e.g. 5 seconds.</p>
<p><br></p>
<p>Problem: what if the Internet connection is so bad that the loading takes 10 seconds?</p>
<p><br></p>
<p><i class="fa-solid fa-arrow-right" aria-hidden="true"></i> &nbsp; we need a more robust solution using <code>tryCatch()</code></p>
</section>
<section id="loading-times-4" class="slide level2">
<h2>Loading times</h2>
<p><br></p>
<p>What we want is to check whether the loading is over, i.e whether the buttons we want to click can be found on the page.</p>
<p><br></p>
<p>We can use a <code>while()</code> loop to check this.</p>
</section>
<section id="loading-times-5" class="slide level2">
<h2>Loading times</h2>
<p>Quick reminder:</p>
<ul>
<li><code>if</code> condition: perform the inside only <strong>if</strong> the condition is true</li>
</ul>
<div class="sourceCode" id="cb28"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href=""></a><span class="cf">if</span> (x <span class="sc">&gt;</span> <span class="dv">2</span>) {</span>
<span id="cb28-2"><a href=""></a>  <span class="co"># do something</span></span>
<span id="cb28-3"><a href=""></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="fragment">
<ul>
<li><code>for</code> loop: perform the inside <strong>for</strong> all values</li>
</ul>
<div class="sourceCode" id="cb29"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href=""></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>) {</span>
<span id="cb29-2"><a href=""></a>  <span class="co"># do something with `i`</span></span>
<span id="cb29-3"><a href=""></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="fragment">
<ul>
<li><code>while</code> loop: perform the inside <strong>while</strong> the condition is true</li>
</ul>
<div class="sourceCode" id="cb30"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href=""></a><span class="cf">while</span> (x <span class="sc">&gt;</span> <span class="dv">2</span>) {</span>
<span id="cb30-2"><a href=""></a>  <span class="co"># do something</span></span>
<span id="cb30-3"><a href=""></a>  <span class="co"># need to update `x` here otherwise infinite loop!</span></span>
<span id="cb30-4"><a href=""></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="loading-times-6" class="slide level2">
<h2>Loading times</h2>
<p>In our case, we want to check whether we can find the buttons “Ver Mais”.</p>
<p><br></p>
<p>Are the buttons loaded?</p>
<ul>
<li>if no, wait 0.5 seconds (or whatever duration you want), and try again;</li>
<li>if yes, go to the next step</li>
</ul>
<p><i class="fa-solid fa-arrow-right" aria-hidden="true"></i> &nbsp; Do this 20 times max</p>
<div class="callout callout-important callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Important</strong></p>
</div>
<div class="callout-content">
<p>This section didn’t work during live demo. The problem is that when we press the button to go to the next page and wait for loading, all the old “Ver mais” buttons are still here and therefore get detected.</p>
<p>The <code>while</code> loop is therefore flawed.</p>
</div>
</div>
</div>
</section>
<section id="loading-times-7" class="slide level2">
<h2>Loading times</h2>
<div class="sourceCode" id="cb31" data-code-line-numbers="1,2,3,4,20|6-14|15-18"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href=""></a><span class="co"># Try to find the buttons "Ver Mais"</span></span>
<span id="cb31-2"><a href=""></a>all_buttons_loaded <span class="ot">&lt;-</span> <span class="cn">FALSE</span></span>
<span id="cb31-3"><a href=""></a>iterations <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb31-4"><a href=""></a><span class="cf">while</span>(<span class="sc">!</span>all_buttons_loaded <span class="sc">&amp;</span> iterations <span class="sc">&lt;</span> <span class="dv">20</span>) {</span>
<span id="cb31-5"><a href=""></a>  <span class="fu">tryCatch</span>(</span>
<span id="cb31-6"><a href=""></a>    {</span>
<span id="cb31-7"><a href=""></a>      test <span class="ot">&lt;-</span> remote_driver<span class="sc">$</span></span>
<span id="cb31-8"><a href=""></a>        <span class="fu">findElements</span>(<span class="at">using =</span> <span class="st">'id'</span>, <span class="at">value =</span> <span class="st">"link_ver_detalhe"</span>)</span>
<span id="cb31-9"><a href=""></a></span>
<span id="cb31-10"><a href=""></a>      <span class="co"># If the buttons are found, update our condition to quit the loop</span></span>
<span id="cb31-11"><a href=""></a>      <span class="cf">if</span> (<span class="fu">inherits</span>(test, <span class="st">"list"</span>) <span class="sc">&amp;&amp;</span> <span class="fu">length</span>(test) <span class="sc">&gt;</span> <span class="dv">0</span>)  {</span>
<span id="cb31-12"><a href=""></a>        all_buttons_loaded <span class="ot">&lt;&lt;-</span> <span class="cn">TRUE</span></span>
<span id="cb31-13"><a href=""></a>      }</span>
<span id="cb31-14"><a href=""></a>    },</span>
<span id="cb31-15"><a href=""></a>    <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb31-16"><a href=""></a>      iterations <span class="ot">&lt;&lt;-</span> iterations <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb31-17"><a href=""></a>      <span class="fu">Sys.sleep</span>(<span class="fl">0.5</span>)</span>
<span id="cb31-18"><a href=""></a>    }</span>
<span id="cb31-19"><a href=""></a>  )</span>
<span id="cb31-20"><a href=""></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This loop will run until the buttons can be found or until we reach 20 iterations.</p>
</section>
<section id="loading-times-8" class="slide level2">
<h2>Loading times</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href=""></a><span class="cf">for</span> (page_index <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">2348</span>) {</span>
<span id="cb32-2"><a href=""></a>  <span class="co"># Try to find the buttons "Ver Mais"</span></span>
<span id="cb32-3"><a href=""></a>  all_buttons_loaded <span class="ot">&lt;-</span> <span class="cn">FALSE</span></span>
<span id="cb32-4"><a href=""></a>  iterations <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb32-5"><a href=""></a>  <span class="cf">while</span> (<span class="sc">!</span>all_buttons_loaded <span class="sc">&amp;</span> iterations <span class="sc">&lt;</span> <span class="dv">20</span>) {</span>
<span id="cb32-6"><a href=""></a>    <span class="fu">tryCatch</span>(</span>
<span id="cb32-7"><a href=""></a>      {</span>
<span id="cb32-8"><a href=""></a>        test <span class="ot">&lt;-</span> remote_driver<span class="sc">$</span><span class="fu">findElements</span>(</span>
<span id="cb32-9"><a href=""></a>          <span class="at">using =</span> <span class="st">'id'</span>,</span>
<span id="cb32-10"><a href=""></a>          <span class="at">value =</span> <span class="st">"link_ver_detalhe"</span></span>
<span id="cb32-11"><a href=""></a>        )</span>
<span id="cb32-12"><a href=""></a></span>
<span id="cb32-13"><a href=""></a>        <span class="cf">if</span> (<span class="fu">inherits</span>(test, <span class="st">"list"</span>) <span class="sc">&amp;&amp;</span> <span class="fu">length</span>(test) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb32-14"><a href=""></a>          all_buttons_loaded <span class="ot">&lt;&lt;-</span> <span class="cn">TRUE</span></span>
<span id="cb32-15"><a href=""></a>        }</span>
<span id="cb32-16"><a href=""></a>      },</span>
<span id="cb32-17"><a href=""></a>      <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb32-18"><a href=""></a>        iterations <span class="ot">&lt;&lt;-</span> iterations <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb32-19"><a href=""></a>        <span class="fu">Sys.sleep</span>(<span class="fl">0.5</span>)</span>
<span id="cb32-20"><a href=""></a>      }</span>
<span id="cb32-21"><a href=""></a>    )</span>
<span id="cb32-22"><a href=""></a>  }</span>
<span id="cb32-23"><a href=""></a></span>
<span id="cb32-24"><a href=""></a>  <span class="cf">if</span> (<span class="sc">!</span>all_buttons_loaded <span class="sc">&amp;</span> iterations <span class="sc">==</span> <span class="dv">20</span>) {</span>
<span id="cb32-25"><a href=""></a>    <span class="cf">next</span></span>
<span id="cb32-26"><a href=""></a>  }</span>
<span id="cb32-27"><a href=""></a></span>
<span id="cb32-28"><a href=""></a>  buttons <span class="ot">&lt;-</span> remote_driver<span class="sc">$</span><span class="fu">findElements</span>(</span>
<span id="cb32-29"><a href=""></a>    <span class="at">using =</span> <span class="st">'id'</span>,</span>
<span id="cb32-30"><a href=""></a>    <span class="at">value =</span> <span class="st">"link_ver_detalhe"</span></span>
<span id="cb32-31"><a href=""></a>  )</span>
<span id="cb32-32"><a href=""></a></span>
<span id="cb32-33"><a href=""></a>  <span class="cf">for</span> (modal_index <span class="cf">in</span> <span class="fu">seq_along</span>(buttons)) {</span>
<span id="cb32-34"><a href=""></a>    <span class="co"># open modal</span></span>
<span id="cb32-35"><a href=""></a>    buttons[[modal_index]]<span class="sc">$</span><span class="fu">clickElement</span>()</span>
<span id="cb32-36"><a href=""></a></span>
<span id="cb32-37"><a href=""></a>    <span class="fu">Sys.sleep</span>(<span class="fl">1.5</span>)</span>
<span id="cb32-38"><a href=""></a></span>
<span id="cb32-39"><a href=""></a>    <span class="co"># Get the HTML and save it</span></span>
<span id="cb32-40"><a href=""></a>    tmp <span class="ot">&lt;-</span> remote_driver<span class="sc">$</span><span class="fu">getPageSource</span>()[[<span class="dv">1</span>]]</span>
<span id="cb32-41"><a href=""></a>    <span class="fu">write</span>(</span>
<span id="cb32-42"><a href=""></a>      tmp,</span>
<span id="cb32-43"><a href=""></a>      <span class="at">file =</span> <span class="fu">paste0</span>(</span>
<span id="cb32-44"><a href=""></a>        <span class="st">"data/modals/page-"</span>,</span>
<span id="cb32-45"><a href=""></a>        page_index,</span>
<span id="cb32-46"><a href=""></a>        <span class="st">"-modal-"</span>,</span>
<span id="cb32-47"><a href=""></a>        modal_index,</span>
<span id="cb32-48"><a href=""></a>        <span class="st">".html"</span></span>
<span id="cb32-49"><a href=""></a>      )</span>
<span id="cb32-50"><a href=""></a>    )</span>
<span id="cb32-51"><a href=""></a></span>
<span id="cb32-52"><a href=""></a>    <span class="co"># Leave the modal</span></span>
<span id="cb32-53"><a href=""></a>    remote_driver<span class="sc">$</span><span class="fu">findElement</span>(</span>
<span id="cb32-54"><a href=""></a>      <span class="at">using =</span> <span class="st">"xpath"</span>,</span>
<span id="cb32-55"><a href=""></a>      <span class="at">value =</span> <span class="st">"/html/body"</span></span>
<span id="cb32-56"><a href=""></a>    )<span class="sc">$</span><span class="fu">sendKeysToElement</span>(<span class="fu">list</span>(<span class="at">key =</span> <span class="st">"escape"</span>))</span>
<span id="cb32-57"><a href=""></a></span>
<span id="cb32-58"><a href=""></a>    <span class="fu">Sys.sleep</span>(<span class="fl">1.5</span>)</span>
<span id="cb32-59"><a href=""></a>  }</span>
<span id="cb32-60"><a href=""></a></span>
<span id="cb32-61"><a href=""></a>  <span class="co"># When we got all modals of one page, go to the next page (except if</span></span>
<span id="cb32-62"><a href=""></a>  <span class="co"># we're on the last one)</span></span>
<span id="cb32-63"><a href=""></a>  <span class="cf">if</span> (page_index <span class="sc">!=</span> <span class="dv">2348</span>) {</span>
<span id="cb32-64"><a href=""></a>    <span class="co"># Give selenium a bit of time to actually find the</span></span>
<span id="cb32-65"><a href=""></a>    <span class="co"># element before clicking it</span></span>
<span id="cb32-66"><a href=""></a>    elem <span class="ot">&lt;-</span> remote_driver<span class="sc">$</span><span class="fu">findElement</span>(<span class="st">"id"</span>, <span class="fu">as.character</span>(page_index <span class="sc">+</span> <span class="dv">1</span>))</span>
<span id="cb32-67"><a href=""></a>    <span class="fu">Sys.sleep</span>(<span class="dv">1</span>)</span>
<span id="cb32-68"><a href=""></a>    elem<span class="sc">$</span><span class="fu">clickElement</span>()</span>
<span id="cb32-69"><a href=""></a>  }</span>
<span id="cb32-70"><a href=""></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section></section>
<section>
<section id="display-and-save-information" class="title-slide slide level1 center">
<h1>3. Display and save information</h1>

</section>
<section id="display-and-save-information-1" class="slide level2">
<h2>Display and save information</h2>
<p><br></p>
<p><strong>Webscraping takes time.</strong></p>
<p><br></p>
<p>It is important to show and save information on how the webscraping is going so that we know where it went wrong for debugging.</p>
<p><br></p>
<div class="fragment">
<p>In our case:</p>
<ul>
<li>show which page is being scraped;</li>
<li>show which modal of this page is being scraped;</li>
<li>show the status of this scraping (success/failure).</li>
</ul>
</div>
</section>
<section id="display-information" class="slide level2">
<h2>Display information</h2>
<p>Use <code>message()</code> at several places in the loop to display information:</p>
<div class="sourceCode" id="cb33" data-code-line-numbers="3,10,16"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href=""></a><span class="cf">for</span> (page_index <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">2348</span>) {</span>
<span id="cb33-2"><a href=""></a></span>
<span id="cb33-3"><a href=""></a>  <span class="fu">message</span>(<span class="fu">paste</span>(<span class="st">"Start scraping of page"</span>, page_index))</span>
<span id="cb33-4"><a href=""></a></span>
<span id="cb33-5"><a href=""></a>  <span class="cf">for</span> (modal_index <span class="cf">in</span> buttons) {</span>
<span id="cb33-6"><a href=""></a>    <span class="co"># open modal</span></span>
<span id="cb33-7"><a href=""></a>    <span class="co"># get HTML and save it in an external file</span></span>
<span id="cb33-8"><a href=""></a>    <span class="co"># leave modal</span></span>
<span id="cb33-9"><a href=""></a></span>
<span id="cb33-10"><a href=""></a>    <span class="fu">message</span>(<span class="fu">paste</span>(<span class="st">"  Scraped modal"</span>, modal_index))</span>
<span id="cb33-11"><a href=""></a>  }</span>
<span id="cb33-12"><a href=""></a></span>
<span id="cb33-13"><a href=""></a>  <span class="co"># Once all modals of a page have been scraped, go to the next page (except</span></span>
<span id="cb33-14"><a href=""></a>  <span class="co"># if we're on the last page)</span></span>
<span id="cb33-15"><a href=""></a></span>
<span id="cb33-16"><a href=""></a>  <span class="fu">message</span>(<span class="fu">paste</span>(<span class="st">"Finished scraping of page"</span>, page_index))</span>
<span id="cb33-17"><a href=""></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="save-information" class="slide level2">
<h2>Save information</h2>
<p><br><br></p>
<p>Problem: what if the R session crashes?</p>
<p><br></p>
<p>We lose all messages!</p>
<p><br></p>
<div class="fragment">
<p>Solution: show these messages <strong>and</strong> save them in an external file at the same time.</p>
</div>
</section>
<section id="save-information-1" class="slide level2">
<h2>Save information</h2>
<p>Example using the package <code>logger</code> (there are also <code>logging</code>, <code>futile.logger</code>, etc.):</p>
<div class="sourceCode" id="cb34" data-code-line-numbers="1,2,3,7,14,20"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href=""></a><span class="co"># save calls to message() in an external file</span></span>
<span id="cb34-2"><a href=""></a><span class="fu">log_appender</span>(<span class="fu">appender_file</span>(<span class="st">"data/modals/00_logfile"</span>))</span>
<span id="cb34-3"><a href=""></a><span class="fu">log_messages</span>()</span>
<span id="cb34-4"><a href=""></a></span>
<span id="cb34-5"><a href=""></a><span class="cf">for</span> (page_index <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">2348</span>) {</span>
<span id="cb34-6"><a href=""></a></span>
<span id="cb34-7"><a href=""></a>  <span class="fu">message</span>(<span class="fu">paste</span>(<span class="st">"Start scraping of page"</span>, page_index))</span>
<span id="cb34-8"><a href=""></a></span>
<span id="cb34-9"><a href=""></a>  <span class="cf">for</span> (modal_index <span class="cf">in</span> buttons) {</span>
<span id="cb34-10"><a href=""></a>    <span class="co"># open modal</span></span>
<span id="cb34-11"><a href=""></a>    <span class="co"># get HTML and save it in an external file</span></span>
<span id="cb34-12"><a href=""></a>    <span class="co"># leave modal</span></span>
<span id="cb34-13"><a href=""></a></span>
<span id="cb34-14"><a href=""></a>    <span class="fu">message</span>(<span class="fu">paste</span>(<span class="st">"  Scraped modal"</span>, modal_index))</span>
<span id="cb34-15"><a href=""></a>  }</span>
<span id="cb34-16"><a href=""></a></span>
<span id="cb34-17"><a href=""></a>  <span class="co"># Once all modals of a page have been scraped, go to the next page (except</span></span>
<span id="cb34-18"><a href=""></a>  <span class="co"># if we're on the last page)</span></span>
<span id="cb34-19"><a href=""></a></span>
<span id="cb34-20"><a href=""></a>  <span class="fu">message</span>(<span class="fu">paste</span>(<span class="st">"Finished scraping of page"</span>, page_index))</span>
<span id="cb34-21"><a href=""></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="save-information-2" class="slide level2">
<h2>Save information</h2>
<p>What does the output look like?</p>
<p><img data-src="img/logfile_demo.png" width="600" height="600"></p>
</section>
<section id="final-loop" class="slide level2">
<h2>Final loop</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href=""></a><span class="cf">for</span> (page_index <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>) {</span>
<span id="cb35-2"><a href=""></a>  <span class="fu">message</span>(<span class="fu">paste</span>(<span class="st">"Start scraping of page"</span>, page_index))</span>
<span id="cb35-3"><a href=""></a></span>
<span id="cb35-4"><a href=""></a>  <span class="co"># Try to find the buttons "Ver Mais"</span></span>
<span id="cb35-5"><a href=""></a>  all_buttons_loaded <span class="ot">&lt;-</span> <span class="cn">FALSE</span></span>
<span id="cb35-6"><a href=""></a>  iterations <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb35-7"><a href=""></a>  <span class="cf">while</span> (<span class="sc">!</span>all_buttons_loaded <span class="sc">&amp;</span> iterations <span class="sc">&lt;</span> <span class="dv">20</span>) {</span>
<span id="cb35-8"><a href=""></a>    <span class="fu">tryCatch</span>(</span>
<span id="cb35-9"><a href=""></a>      {</span>
<span id="cb35-10"><a href=""></a>        test <span class="ot">&lt;-</span> remote_driver<span class="sc">$</span><span class="fu">findElements</span>(</span>
<span id="cb35-11"><a href=""></a>          <span class="at">using =</span> <span class="st">'id'</span>,</span>
<span id="cb35-12"><a href=""></a>          <span class="at">value =</span> <span class="st">"link_ver_detalhe"</span></span>
<span id="cb35-13"><a href=""></a>        )</span>
<span id="cb35-14"><a href=""></a></span>
<span id="cb35-15"><a href=""></a>        <span class="cf">if</span> (<span class="fu">inherits</span>(test, <span class="st">"list"</span>) <span class="sc">&amp;&amp;</span> <span class="fu">length</span>(test) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb35-16"><a href=""></a>          all_buttons_loaded <span class="ot">&lt;&lt;-</span> <span class="cn">TRUE</span></span>
<span id="cb35-17"><a href=""></a>        }</span>
<span id="cb35-18"><a href=""></a>      },</span>
<span id="cb35-19"><a href=""></a>      <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb35-20"><a href=""></a>        iterations <span class="ot">&lt;&lt;-</span> iterations <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb35-21"><a href=""></a>        <span class="fu">Sys.sleep</span>(<span class="fl">0.5</span>)</span>
<span id="cb35-22"><a href=""></a>      }</span>
<span id="cb35-23"><a href=""></a>    )</span>
<span id="cb35-24"><a href=""></a>  }</span>
<span id="cb35-25"><a href=""></a></span>
<span id="cb35-26"><a href=""></a>  <span class="cf">if</span> (<span class="sc">!</span>all_buttons_loaded <span class="sc">&amp;</span> iterations <span class="sc">==</span> <span class="dv">20</span>) {</span>
<span id="cb35-27"><a href=""></a>    <span class="fu">message</span>(<span class="fu">paste0</span>(<span class="st">"Couldn't find buttons on page "</span>, page_index, <span class="st">". Skipping."</span>))</span>
<span id="cb35-28"><a href=""></a>    <span class="cf">next</span></span>
<span id="cb35-29"><a href=""></a>  }</span>
<span id="cb35-30"><a href=""></a></span>
<span id="cb35-31"><a href=""></a>  buttons <span class="ot">&lt;-</span> remote_driver<span class="sc">$</span><span class="fu">findElements</span>(</span>
<span id="cb35-32"><a href=""></a>    <span class="at">using =</span> <span class="st">'id'</span>,</span>
<span id="cb35-33"><a href=""></a>    <span class="at">value =</span> <span class="st">"link_ver_detalhe"</span></span>
<span id="cb35-34"><a href=""></a>  )</span>
<span id="cb35-35"><a href=""></a></span>
<span id="cb35-36"><a href=""></a>  <span class="cf">for</span> (modal_index <span class="cf">in</span> <span class="fu">seq_along</span>(buttons)) {</span>
<span id="cb35-37"><a href=""></a>    <span class="fu">tryCatch</span>(</span>
<span id="cb35-38"><a href=""></a>      {</span>
<span id="cb35-39"><a href=""></a>        <span class="co"># open modal</span></span>
<span id="cb35-40"><a href=""></a>        buttons[[modal_index]]<span class="sc">$</span><span class="fu">clickElement</span>()</span>
<span id="cb35-41"><a href=""></a></span>
<span id="cb35-42"><a href=""></a>        <span class="fu">Sys.sleep</span>(<span class="fl">1.5</span>)</span>
<span id="cb35-43"><a href=""></a></span>
<span id="cb35-44"><a href=""></a>        <span class="co"># Get the HTML and save it</span></span>
<span id="cb35-45"><a href=""></a>        tmp <span class="ot">&lt;-</span> remote_driver<span class="sc">$</span><span class="fu">getPageSource</span>()[[<span class="dv">1</span>]]</span>
<span id="cb35-46"><a href=""></a>        <span class="fu">write</span>(</span>
<span id="cb35-47"><a href=""></a>          tmp,</span>
<span id="cb35-48"><a href=""></a>          <span class="at">file =</span> <span class="fu">paste0</span>(</span>
<span id="cb35-49"><a href=""></a>            <span class="st">"data/modals/page-"</span>,</span>
<span id="cb35-50"><a href=""></a>            page_index,</span>
<span id="cb35-51"><a href=""></a>            <span class="st">"-modal-"</span>,</span>
<span id="cb35-52"><a href=""></a>            modal_index,</span>
<span id="cb35-53"><a href=""></a>            <span class="st">".html"</span></span>
<span id="cb35-54"><a href=""></a>          )</span>
<span id="cb35-55"><a href=""></a>        )</span>
<span id="cb35-56"><a href=""></a></span>
<span id="cb35-57"><a href=""></a>        <span class="co"># Leave the modal</span></span>
<span id="cb35-58"><a href=""></a>        body <span class="ot">&lt;-</span> remote_driver<span class="sc">$</span><span class="fu">findElement</span>(<span class="at">using =</span> <span class="st">"xpath"</span>, <span class="at">value =</span> <span class="st">"/html/body"</span>)</span>
<span id="cb35-59"><a href=""></a>        body<span class="sc">$</span><span class="fu">sendKeysToElement</span>(<span class="fu">list</span>(<span class="at">key =</span> <span class="st">"escape"</span>))</span>
<span id="cb35-60"><a href=""></a></span>
<span id="cb35-61"><a href=""></a>        <span class="fu">message</span>(<span class="fu">paste</span>(<span class="st">"  Scraped modal"</span>, modal_index))</span>
<span id="cb35-62"><a href=""></a>      },</span>
<span id="cb35-63"><a href=""></a>      <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb35-64"><a href=""></a>        <span class="fu">message</span>(<span class="fu">paste</span>(<span class="st">"  Failed to scrape modal"</span>, modal_index))</span>
<span id="cb35-65"><a href=""></a>        <span class="fu">message</span>(<span class="fu">paste</span>(<span class="st">"  The error was "</span>, e))</span>
<span id="cb35-66"><a href=""></a>        <span class="cf">next</span></span>
<span id="cb35-67"><a href=""></a>      }</span>
<span id="cb35-68"><a href=""></a>    )</span>
<span id="cb35-69"><a href=""></a></span>
<span id="cb35-70"><a href=""></a>    <span class="fu">Sys.sleep</span>(<span class="fl">1.5</span>)</span>
<span id="cb35-71"><a href=""></a>  }</span>
<span id="cb35-72"><a href=""></a></span>
<span id="cb35-73"><a href=""></a>  <span class="co"># When we got all modals of one page, go to the next page (except if</span></span>
<span id="cb35-74"><a href=""></a>  <span class="co"># we're on the last one)</span></span>
<span id="cb35-75"><a href=""></a>  <span class="cf">if</span> (page_index <span class="sc">!=</span> <span class="dv">2348</span>) {</span>
<span id="cb35-76"><a href=""></a>    <span class="co"># Give selenium a bit of time to actually find the</span></span>
<span id="cb35-77"><a href=""></a>    <span class="co"># element before clicking it</span></span>
<span id="cb35-78"><a href=""></a>    elem <span class="ot">&lt;-</span> remote_driver<span class="sc">$</span><span class="fu">findElement</span>(<span class="st">"id"</span>, <span class="fu">as.character</span>(page_index <span class="sc">+</span> <span class="dv">1</span>))</span>
<span id="cb35-79"><a href=""></a>    <span class="fu">Sys.sleep</span>(<span class="dv">1</span>)</span>
<span id="cb35-80"><a href=""></a>    elem<span class="sc">$</span><span class="fu">clickElement</span>()</span>
<span id="cb35-81"><a href=""></a>  }</span>
<span id="cb35-82"><a href=""></a></span>
<span id="cb35-83"><a href=""></a>  <span class="fu">message</span>(<span class="fu">paste</span>(<span class="st">"Finished scraping of page"</span>, page_index))</span>
<span id="cb35-84"><a href=""></a></span>
<span id="cb35-85"><a href=""></a>  <span class="co"># Wait a bit for page loading</span></span>
<span id="cb35-86"><a href=""></a>  <span class="fu">Sys.sleep</span>(<span class="dv">3</span>)</span>
<span id="cb35-87"><a href=""></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section></section>
<section>
<section id="now-what" class="title-slide slide level1 center">
<h1>Now what?</h1>

</section>
<section class="slide level2">

<p><br> <br></p>
<p>If everything went well, we now have a bunch of <code>.html</code> files in <code>data/modals</code>.</p>
<p><br></p>
<p>To clean them, we don’t need <code>RSelenium</code> or an internet connection. These are just text files, they are not “tied” to the website anymore.</p>
<p><br></p>
<p>It is also useful to keep them for reproducibility (same as when you keep the raw datasets in your project).</p>
</section>
<section class="slide level2">

<p>Make a function to clean the HTML. It returns a list containing a dataframe with the personal info, and a dataframe with the “network” of the individual.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href=""></a>extract_information <span class="ot">&lt;-</span> <span class="cf">function</span>(raw_html) {</span>
<span id="cb36-2"><a href=""></a>  <span class="co"># Extract the table "Registros relacionados"</span></span>
<span id="cb36-3"><a href=""></a></span>
<span id="cb36-4"><a href=""></a>  content <span class="ot">&lt;-</span> raw_html <span class="sc">%&gt;%</span></span>
<span id="cb36-5"><a href=""></a>    <span class="fu">html_nodes</span>(<span class="st">"#detalhe_conteudo"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb36-6"><a href=""></a>    <span class="fu">html_table</span>() <span class="sc">%&gt;%</span></span>
<span id="cb36-7"><a href=""></a>    purrr<span class="sc">::</span><span class="fu">pluck</span>(<span class="dv">1</span>)</span>
<span id="cb36-8"><a href=""></a></span>
<span id="cb36-9"><a href=""></a>  relacionados <span class="ot">&lt;-</span> content[<span class="dv">16</span><span class="sc">:</span><span class="fu">nrow</span>(content), ] <span class="sc">%&gt;%</span></span>
<span id="cb36-10"><a href=""></a>    <span class="fu">mutate</span>(</span>
<span id="cb36-11"><a href=""></a>      <span class="fu">across</span>(</span>
<span id="cb36-12"><a href=""></a>        <span class="at">.cols =</span> <span class="fu">everything</span>(),</span>
<span id="cb36-13"><a href=""></a>        <span class="at">.fns =</span> <span class="sc">~</span> {</span>
<span id="cb36-14"><a href=""></a>          <span class="fu">ifelse</span>(.x <span class="sc">==</span> <span class="st">""</span>, <span class="cn">NA</span>, .x)</span>
<span id="cb36-15"><a href=""></a>        }</span>
<span id="cb36-16"><a href=""></a>      )</span>
<span id="cb36-17"><a href=""></a>    )</span>
<span id="cb36-18"><a href=""></a></span>
<span id="cb36-19"><a href=""></a>  <span class="fu">colnames</span>(relacionados) <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb36-20"><a href=""></a>    <span class="st">"Livro"</span>,</span>
<span id="cb36-21"><a href=""></a>    <span class="st">"Pagina"</span>,</span>
<span id="cb36-22"><a href=""></a>    <span class="st">"Familia"</span>,</span>
<span id="cb36-23"><a href=""></a>    <span class="st">"Chegada"</span>,</span>
<span id="cb36-24"><a href=""></a>    <span class="st">"Sobrenome"</span>,</span>
<span id="cb36-25"><a href=""></a>    <span class="st">"Nome"</span>,</span>
<span id="cb36-26"><a href=""></a>    <span class="st">"Idade"</span>,</span>
<span id="cb36-27"><a href=""></a>    <span class="st">"Sexo"</span>,</span>
<span id="cb36-28"><a href=""></a>    <span class="st">"Parentesco"</span>,</span>
<span id="cb36-29"><a href=""></a>    <span class="st">"Nacionalidade"</span>,</span>
<span id="cb36-30"><a href=""></a>    <span class="st">"Vapor"</span>,</span>
<span id="cb36-31"><a href=""></a>    <span class="st">"Est.Civil"</span>,</span>
<span id="cb36-32"><a href=""></a>    <span class="st">"Religiao"</span></span>
<span id="cb36-33"><a href=""></a>  )</span>
<span id="cb36-34"><a href=""></a></span>
<span id="cb36-35"><a href=""></a>  <span class="co"># Extract text information from "registro de matricula" and create a</span></span>
<span id="cb36-36"><a href=""></a>  <span class="co"># dataframe from it</span></span>
<span id="cb36-37"><a href=""></a>  name_items <span class="ot">&lt;-</span> raw_html <span class="sc">%&gt;%</span></span>
<span id="cb36-38"><a href=""></a>    <span class="fu">html_elements</span>(</span>
<span id="cb36-39"><a href=""></a>      <span class="at">xpath =</span> <span class="st">'//*[@id="detalhe_conteudo"]/table[1]/tbody/tr/td/strong'</span></span>
<span id="cb36-40"><a href=""></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb36-41"><a href=""></a>    <span class="fu">html_text2</span>() <span class="sc">%&gt;%</span></span>
<span id="cb36-42"><a href=""></a>    <span class="fu">gsub</span>(<span class="st">"</span><span class="sc">\\</span><span class="st">n"</span>, <span class="st">""</span>, .) <span class="sc">%&gt;%</span></span>
<span id="cb36-43"><a href=""></a>    <span class="fu">strsplit</span>(<span class="at">split =</span> <span class="st">"</span><span class="sc">\\</span><span class="st">t"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb36-44"><a href=""></a>    <span class="fu">unlist</span>()</span>
<span id="cb36-45"><a href=""></a></span>
<span id="cb36-46"><a href=""></a>  value_items <span class="ot">&lt;-</span> raw_html <span class="sc">%&gt;%</span></span>
<span id="cb36-47"><a href=""></a>    <span class="fu">html_elements</span>(</span>
<span id="cb36-48"><a href=""></a>      <span class="at">xpath =</span> <span class="st">'//*[@id="detalhe_conteudo"]/table[1]/tbody/tr/td/div'</span></span>
<span id="cb36-49"><a href=""></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb36-50"><a href=""></a>    <span class="fu">html_text2</span>()</span>
<span id="cb36-51"><a href=""></a></span>
<span id="cb36-52"><a href=""></a>  registro <span class="ot">&lt;-</span> <span class="fu">data.frame</span>() <span class="sc">%&gt;%</span></span>
<span id="cb36-53"><a href=""></a>    <span class="fu">rbind</span>(value_items) <span class="sc">%&gt;%</span></span>
<span id="cb36-54"><a href=""></a>    <span class="fu">as_tibble</span>()</span>
<span id="cb36-55"><a href=""></a></span>
<span id="cb36-56"><a href=""></a>  <span class="fu">colnames</span>(registro) <span class="ot">&lt;-</span> name_items</span>
<span id="cb36-57"><a href=""></a></span>
<span id="cb36-58"><a href=""></a>  <span class="fu">return</span>(</span>
<span id="cb36-59"><a href=""></a>    <span class="fu">list</span>(</span>
<span id="cb36-60"><a href=""></a>      <span class="at">main =</span> registro,</span>
<span id="cb36-61"><a href=""></a>      <span class="at">related =</span> relacionados</span>
<span id="cb36-62"><a href=""></a>    )</span>
<span id="cb36-63"><a href=""></a>  )</span>
<span id="cb36-64"><a href=""></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section class="slide level2">

<p>Apply this function to all files:</p>
<p><br></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href=""></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb37-2"><a href=""></a><span class="fu">library</span>(rvest)</span>
<span id="cb37-3"><a href=""></a></span>
<span id="cb37-4"><a href=""></a><span class="co"># Get all paths to the html files</span></span>
<span id="cb37-5"><a href=""></a>list_html_files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(</span>
<span id="cb37-6"><a href=""></a>  <span class="st">"data/modals"</span>,</span>
<span id="cb37-7"><a href=""></a>  <span class="at">pattern =</span> <span class="st">"page"</span>,</span>
<span id="cb37-8"><a href=""></a>  <span class="at">full.names =</span> <span class="cn">TRUE</span></span>
<span id="cb37-9"><a href=""></a>)</span>
<span id="cb37-10"><a href=""></a></span>
<span id="cb37-11"><a href=""></a><span class="co"># Apply the previous function to each of those file</span></span>
<span id="cb37-12"><a href=""></a>list_out <span class="ot">&lt;-</span> <span class="fu">lapply</span>(list_html_files, <span class="cf">function</span>(x) {</span>
<span id="cb37-13"><a href=""></a>  <span class="fu">read_html</span>(x) <span class="sc">|&gt;</span></span>
<span id="cb37-14"><a href=""></a>    <span class="fu">extract_information</span>()</span>
<span id="cb37-15"><a href=""></a>})</span>
<span id="cb37-16"><a href=""></a></span>
<span id="cb37-17"><a href=""></a><span class="co"># Aggregate the results in two (single) datasets</span></span>
<span id="cb37-18"><a href=""></a>main <span class="ot">&lt;-</span> data.table<span class="sc">::</span><span class="fu">rbindlist</span>(purrr<span class="sc">::</span><span class="fu">map</span>(list_out, <span class="dv">1</span>)) <span class="sc">|&gt;</span></span>
<span id="cb37-19"><a href=""></a>  <span class="fu">as_tibble</span>()</span>
<span id="cb37-20"><a href=""></a></span>
<span id="cb37-21"><a href=""></a>relations <span class="ot">&lt;-</span> data.table<span class="sc">::</span><span class="fu">rbindlist</span>(purrr<span class="sc">::</span><span class="fu">map</span>(list_out, <span class="dv">2</span>)) <span class="sc">|&gt;</span></span>
<span id="cb37-22"><a href=""></a>  <span class="fu">as_tibble</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section></section>
<section>
<section id="summary" class="title-slide slide level1 center">
<h1>Summary</h1>

</section>
<section class="slide level2">

<p><br></p>
<ol type="1">
<li><code>Selenium</code> in general is a very useful tool but should be used as a last resort:</li>
</ol>
<ul>
<li>APIs, packages</li>
<li>static webscraping</li>
<li>custom <code>POST</code> requests (link in conclusion)</li>
</ul>
<div class="fragment">
<ol start="2" type="1">
<li>In my (limited) experience:</li>
</ol>
<ul>
<li>1/4 of the time is spent on making a small example work;</li>
<li>1/4 of the time is spent on generalising this example (loops, etc.)</li>
<li><strong>1/2</strong> of the time is spent on debugging.</li>
</ul>
<p><br></p>
</div>
<div class="fragment">
<p><strong><em>Catching errors and recording the scraping process IS important.</em></strong></p>
</div>
</section>
<section id="parallelization" class="slide level2">
<h2>Parallelization</h2>
<p><br></p>
<p>Use parallelization to open several browsers at the same time and scrape the data faster.</p>
<p><br></p>
<p><i class="fa-solid fa-triangle-exclamation" aria-hidden="true"></i> &nbsp; I never tested this, and there could be some issues (browser crashes, etc.)</p>
<p><br></p>
<p>If you want to explore it:</p>
<ul>
<li><p><a href="https://appsilon.com/webscraping-dynamic-websites-with-r/" class="external" target="_blank">article by Appsilon</a> (at the end)</p></li>
<li><p><a href="https://ivanmillanes.netlify.app/post/2020-06-30-webscraping-with-rselenium-and-rvest/#parallel-framework" class="external" target="_blank">article by Ivan Millanes</a></p></li>
</ul>
</section>
<section id="ethics" class="slide level2">
<h2>Ethics</h2>
<p>Pay attention to a website’s Terms of Use/Service.</p>
<p><br></p>
<p>Some websites explicitly say that you are not allowed to programmatically access their resources.</p>
<p><br></p>

<img data-src="img/terms-of-use.png" class="r-stretch"></section>
<section id="ethics-1" class="slide level2">
<h2>Ethics</h2>
<p><br> <br></p>
<p><strong>Be respectful</strong>: make the scraping slow enough not to overload the server.</p>
<p><br></p>
<p>Not every website can handle tens of thousands of requests very quickly.</p>
<p><br></p>
<div class="callout callout-tip callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Tip</strong></p>
</div>
<div class="callout-content">
<p>For static webscraping, check out the package <a href="https://dmi3kno.github.io/polite/" class="external" target="_blank"><code>polite</code></a>.</p>
</div>
</div>
</div>
</section>
<section id="other-tools" class="slide level2">
<h2>Other tools</h2>
<p><br></p>
<ul>
<li><code>Selenium</code> is also available in Python.</li>
</ul>
<p><br></p>
<ul>
<li>Python also has a library called <a href="https://playwright.dev/python/"><code>playwright</code></a> (never used myself).</li>
</ul>
</section>
<section id="conclusion" class="slide level2">
<h2>Conclusion</h2>
<p><br></p>
<p>Code on GitHub: <a href="https://github.com/etiennebacher/innsbruck_teaching_may_2025">https://github.com/etiennebacher/innsbruck_teaching_may_2025</a></p>
</section></section>
<section id="good-resources" class="title-slide slide level1 center">
<h1>Good resources</h1>
<p><br></p>
<p>Article from Appsilon:</p>
<p><a href="https://appsilon.com/webscraping-dynamic-websites-with-r/" class="external" target="_blank">https://appsilon.com/webscraping-dynamic-websites-with-r/</a></p>
<p><br></p>
<p>Article from Ivan Millanes:</p>
<p><a href="https://ivanmillanes.netlify.app/post/2020-06-30-webscraping-with-rselenium-and-rvest/" class="external" target="_blank">https://ivanmillanes.netlify.app/post/2020-06-30-webscraping-with-rselenium-and-rvest/</a></p>
<p><br></p>
<p>Using POST requests instead of <code>RSelenium</code>: <a href="https://www.etiennebacher.com/posts/2023-05-09-making-post-requests-with-r/">https://www.etiennebacher.com/posts/2023-05-09-making-post-requests-with-r/</a></p>
</section>

<section>
<section id="appendix" class="title-slide slide level1 center">
<h1>Appendix</h1>

</section>
<section id="contributors-results" class="slide level2">
<h2>Appendix</h2>
<p>For reference, here’s the code to extract the list of contributors:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href=""></a><span class="fu">library</span>(rvest)</span>
<span id="cb38-2"><a href=""></a></span>
<span id="cb38-3"><a href=""></a>html <span class="ot">&lt;-</span> <span class="fu">read_html</span>(<span class="st">"contributors.html"</span>)</span>
<span id="cb38-4"><a href=""></a></span>
<span id="cb38-5"><a href=""></a>bullet_points <span class="ot">&lt;-</span> html <span class="sc">%&gt;%</span></span>
<span id="cb38-6"><a href=""></a>  <span class="fu">html_elements</span>(<span class="at">css =</span> <span class="st">"div.col-xs-12 &gt; ul &gt; li"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb38-7"><a href=""></a>  <span class="fu">html_text</span>()</span>
<span id="cb38-8"><a href=""></a></span>
<span id="cb38-9"><a href=""></a>blockquote <span class="ot">&lt;-</span> html <span class="sc">%&gt;%</span></span>
<span id="cb38-10"><a href=""></a>  <span class="fu">html_elements</span>(<span class="at">css =</span> <span class="st">"div.col-xs-12.col-sm-7 &gt; blockquote"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb38-11"><a href=""></a>  <span class="fu">html_text</span>() <span class="sc">%&gt;%</span></span>
<span id="cb38-12"><a href=""></a>  <span class="fu">strsplit</span>(., <span class="at">split =</span> <span class="st">", "</span>)</span>
<span id="cb38-13"><a href=""></a></span>
<span id="cb38-14"><a href=""></a>blockquote <span class="ot">&lt;-</span> blockquote[[<span class="dv">1</span>]] <span class="sc">%&gt;%</span></span>
<span id="cb38-15"><a href=""></a>  <span class="fu">gsub</span>(<span class="st">"</span><span class="sc">\\</span><span class="st">r|</span><span class="sc">\\</span><span class="st">n|</span><span class="sc">\\</span><span class="st">.|and"</span>, <span class="st">""</span>, .)</span>
<span id="cb38-16"><a href=""></a></span>
<span id="cb38-17"><a href=""></a>others <span class="ot">&lt;-</span> html <span class="sc">%&gt;%</span></span>
<span id="cb38-18"><a href=""></a>  <span class="fu">html_elements</span>(<span class="at">xpath =</span> <span class="st">"/html/body/div/div[1]/div[2]/p[5]"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb38-19"><a href=""></a>  <span class="fu">html_text</span>() <span class="sc">%&gt;%</span></span>
<span id="cb38-20"><a href=""></a>  <span class="fu">strsplit</span>(., <span class="at">split =</span> <span class="st">", "</span>)</span>
<span id="cb38-21"><a href=""></a></span>
<span id="cb38-22"><a href=""></a>others <span class="ot">&lt;-</span> others[[<span class="dv">1</span>]] <span class="sc">%&gt;%</span></span>
<span id="cb38-23"><a href=""></a>  <span class="fu">gsub</span>(<span class="st">"</span><span class="sc">\\</span><span class="st">r|</span><span class="sc">\\</span><span class="st">n|</span><span class="sc">\\</span><span class="st">.|and"</span>, <span class="st">""</span>, .)</span>
<span id="cb38-24"><a href=""></a></span>
<span id="cb38-25"><a href=""></a>all_contributors <span class="ot">&lt;-</span> <span class="fu">c</span>(bullet_points, blockquote, others)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="appendix-1" class="slide level2">
<h2>Appendix</h2>
<p><a href="#/contributors-last-step">Back</a></p>
</section>
<section id="appendix-2" class="slide level2">
<h2>Appendix</h2>
<p><br></p>
<p>Bonus: get the data from each modal on the museum website by performing the <code>POST</code> request yourself.</p>
<p><br></p>
<p>Go to the tab “Network” in the developer console, and then click on one of the “Ver Mais” button to display the modal.</p>
</section>
<section id="appendix-3" class="slide level2">
<h2>Appendix</h2>
<p>Clicking on this button triggers two <code>POST</code> requests:</p>
<ul>
<li>one for the individual information;</li>
<li>one for the “network” of the individual.</li>
</ul>

<img data-src="img/console_network.png" class="r-stretch"></section>
<section id="appendix-4" class="slide level2">
<h2>Appendix</h2>
<p><br></p>
<p>Clicking on one of the <code>POST</code> requests displays important information:</p>
<ul>
<li>the <strong>request</strong>, what we send to the server;</li>
<li>the <strong>response</strong>, what the server sends back to us.</li>
</ul>
<div class="fragment">
<p>The request contains specific parameters needed to tell the server which data we need.</p>
</div>
</section>
<section id="appendix-5" class="slide level2" data-auto-animate="true">
<h2 data-id="quarto-animate-title">Appendix</h2>
<p>Let’s rebuild this <code>POST</code> request from R using the package <code>httr</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode numberSource r number-lines code-with-copy" data-id="quarto-animate-code"><code class="sourceCode r hljs"><span id="cb39-1" class="hljs-ln-code"><a href=""></a><span class="fu">library</span>(httr)</span>
<span id="cb39-2" class="hljs-ln-code"><a href=""></a></span>
<span id="cb39-3" class="hljs-ln-code"><a href=""></a>x <span class="ot">&lt;-</span> <span class="fu">POST</span>(</span>
<span id="cb39-4" class="hljs-ln-code"><a href=""></a>  <span class="st">"http://www.arquivoestado.sp.gov.br/site/acervo/memoria_do_imigrante/getHospedariaDetalhe"</span>,</span>
<span id="cb39-5" class="hljs-ln-code"><a href=""></a>  <span class="at">body =</span> <span class="fu">list</span>(</span>
<span id="cb39-6" class="hljs-ln-code"><a href=""></a>    <span class="at">id =</span> <span class="st">"92276"</span></span>
<span id="cb39-7" class="hljs-ln-code"><a href=""></a>  ),</span>
<span id="cb39-8" class="hljs-ln-code"><a href=""></a>  <span class="at">encode =</span> <span class="st">"multipart"</span></span>
<span id="cb39-9" class="hljs-ln-code"><a href=""></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="appendix-6" class="slide level2" data-auto-animate="true">
<h2 data-id="quarto-animate-title">Appendix</h2>
<p>Extract the data from the server response:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode numberSource r number-lines code-with-copy" data-id="quarto-animate-code"><code class="sourceCode r hljs"><span id="cb40-1" class="hljs-ln-code"><a href=""></a><span class="fu">library</span>(httr)</span>
<span id="cb40-2" class="hljs-ln-code"><a href=""></a><span class="fu">library</span>(xml2)</span>
<span id="cb40-3" class="hljs-ln-code"><a href=""></a><span class="fu">library</span>(jsonlite)</span>
<span id="cb40-4" class="hljs-ln-code"><a href=""></a></span>
<span id="cb40-5" class="hljs-ln-code"><a href=""></a><span class="co"># make the POST request with the parameters needed</span></span>
<span id="cb40-6" class="hljs-ln-code"><a href=""></a>x <span class="ot">&lt;-</span> <span class="fu">POST</span>(</span>
<span id="cb40-7" class="hljs-ln-code"><a href=""></a>  <span class="st">"http://www.arquivoestado.sp.gov.br/site/acervo/memoria_do_imigrante/getHospedariaDetalhe"</span>,</span>
<span id="cb40-8" class="hljs-ln-code"><a href=""></a>  <span class="at">body =</span> <span class="fu">list</span>(</span>
<span id="cb40-9" class="hljs-ln-code"><a href=""></a>    <span class="at">id =</span> <span class="st">"92276"</span></span>
<span id="cb40-10" class="hljs-ln-code"><a href=""></a>  ),</span>
<span id="cb40-11" class="hljs-ln-code"><a href=""></a>  <span class="at">encode =</span> <span class="st">"multipart"</span></span>
<span id="cb40-12" class="hljs-ln-code"><a href=""></a>)</span>
<span id="cb40-13" class="hljs-ln-code"><a href=""></a></span>
<span id="cb40-14" class="hljs-ln-code"><a href=""></a><span class="co"># convert output to a list</span></span>
<span id="cb40-15" class="hljs-ln-code"><a href=""></a>out <span class="ot">&lt;-</span> <span class="fu">as_list</span>(<span class="fu">content</span>(x))</span>
<span id="cb40-16" class="hljs-ln-code"><a href=""></a></span>
<span id="cb40-17" class="hljs-ln-code"><a href=""></a><span class="co"># convert output to a dataframe</span></span>
<span id="cb40-18" class="hljs-ln-code"><a href=""></a><span class="fu">fromJSON</span>(<span class="fu">unlist</span>(out))<span class="sc">$</span>dados</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="your-turn" class="slide level2">
<h2>Your turn</h2>
<p><br></p>
<p>Do the same thing with the second <code>POST</code> request, which has 3 parameters instead of one.</p>
</section>
<section id="session-information" class="slide level2">
<h2>Session information</h2>
<p><br></p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>─ Session info ───────────────────────────────────────────────────────────────
 setting  value
 version  R version 4.5.0 (2025-04-11)
 os       Ubuntu 24.04.2 LTS
 system   x86_64, linux-gnu
 ui       X11
 language (EN)
 collate  en_US.UTF-8
 ctype    en_US.UTF-8
 tz       Europe/Paris
 date     2025-06-02
 pandoc   3.1.3 @ /usr/bin/ (via rmarkdown)
 quarto   1.6.40 @ /home/etienne/.local/lib/python3.12/site-packages/quarto_cli/bin/quarto

─ Packages ───────────────────────────────────────────────────────────────────
 package     * version date (UTC) lib source
 cli           3.6.4   2025-02-13 [1] RSPM
 digest        0.6.37  2024-08-19 [1] RSPM
 evaluate      1.0.3   2025-01-10 [1] RSPM
 fastmap       1.2.0   2024-05-15 [1] RSPM
 htmltools     0.5.8.1 2024-04-04 [1] RSPM
 jsonlite      2.0.0   2025-03-27 [1] RSPM
 knitr         1.50    2025-03-16 [1] RSPM
 rlang         1.1.6   2025-04-11 [1] CRAN (R 4.5.0)
 rmarkdown     2.29    2024-11-04 [1] RSPM
 sessioninfo   1.2.3   2025-02-05 [1] RSPM
 xfun          0.52    2025-04-02 [1] RSPM
 yaml          2.3.10  2024-07-26 [1] RSPM

 [1] /home/etienne/R/x86_64-pc-linux-gnu-library/4.5
 [2] /opt/R/4.5.0/lib/R/library

──────────────────────────────────────────────────────────────────────────────</code></pre>
</div>
</div>

</section></section>

    </div>
  <div class="quarto-auto-generated-content" style="display: none;">
<div class="footer footer-default">

</div>
</div></div>

  <script>window.backupDefine = window.define; window.define = undefined;</script>
  <script src="index_files/libs/revealjs/dist/reveal.js"></script>
  <!-- reveal.js plugins -->
  <script src="index_files/libs/revealjs/plugin/quarto-line-highlight/line-highlight.js"></script>
  <script src="index_files/libs/revealjs/plugin/pdf-export/pdfexport.js"></script>
  <script src="index_files/libs/revealjs/plugin/reveal-menu/menu.js"></script>
  <script src="index_files/libs/revealjs/plugin/reveal-menu/quarto-menu.js"></script>
  <script src="index_files/libs/revealjs/plugin/quarto-support/support.js"></script>
  

  <script src="index_files/libs/revealjs/plugin/notes/notes.js"></script>
  <script src="index_files/libs/revealjs/plugin/search/search.js"></script>
  <script src="index_files/libs/revealjs/plugin/zoom/zoom.js"></script>
  <script src="index_files/libs/revealjs/plugin/math/math.js"></script>
  <script>window.define = window.backupDefine; window.backupDefine = undefined;</script>

  <script>

      // Full list of configuration options available at:
      // https://revealjs.com/config/
      Reveal.initialize({
'controlsAuto': true,
'previewLinksAuto': false,
'pdfSeparateFragments': true,
'autoAnimateEasing': "ease",
'autoAnimateDuration': 0.8,
'autoAnimateUnmatched': true,
'jumpToSlide': true,
'menu': {"side":"left","useTextContentForMissingTitles":true,"markers":false,"loadIcons":false,"custom":[{"title":"Tools","icon":"<i class=\"fas fa-gear\"></i>","content":"<ul class=\"slide-menu-items\">\n<li class=\"slide-tool-item active\" data-item=\"0\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.fullscreen(event)\"><kbd>f</kbd> Fullscreen</a></li>\n<li class=\"slide-tool-item\" data-item=\"1\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.speakerMode(event)\"><kbd>s</kbd> Speaker View</a></li>\n<li class=\"slide-tool-item\" data-item=\"2\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.overview(event)\"><kbd>o</kbd> Slide Overview</a></li>\n<li class=\"slide-tool-item\" data-item=\"3\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.togglePdfExport(event)\"><kbd>e</kbd> PDF Export Mode</a></li>\n<li class=\"slide-tool-item\" data-item=\"4\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.toggleScrollView(event)\"><kbd>r</kbd> Scroll View Mode</a></li>\n<li class=\"slide-tool-item\" data-item=\"5\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.keyboardHelp(event)\"><kbd>?</kbd> Keyboard Help</a></li>\n</ul>"}],"openButton":true},
'smaller': false,
 
        // Display controls in the bottom right corner
        controls: false,

        // Help the user learn the controls by providing hints, for example by
        // bouncing the down arrow when they first encounter a vertical slide
        controlsTutorial: false,

        // Determines where controls appear, "edges" or "bottom-right"
        controlsLayout: 'edges',

        // Visibility rule for backwards navigation arrows; "faded", "hidden"
        // or "visible"
        controlsBackArrows: 'faded',

        // Display a presentation progress bar
        progress: true,

        // Display the page number of the current slide
        slideNumber: 'c/t',

        // 'all', 'print', or 'speaker'
        showSlideNumber: 'all',

        // Add the current slide number to the URL hash so that reloading the
        // page/copying the URL will return you to the same slide
        hash: true,

        // Start with 1 for the hash rather than 0
        hashOneBasedIndex: false,

        // Flags if we should monitor the hash and change slides accordingly
        respondToHashChanges: true,

        // Push each slide change to the browser history
        history: true,

        // Enable keyboard shortcuts for navigation
        keyboard: true,

        // Enable the slide overview mode
        overview: true,

        // Disables the default reveal.js slide layout (scaling and centering)
        // so that you can use custom CSS layout
        disableLayout: false,

        // Vertical centering of slides
        center: false,

        // Enables touch navigation on devices with touch input
        touch: true,

        // Loop the presentation
        loop: false,

        // Change the presentation direction to be RTL
        rtl: false,

        // see https://revealjs.com/vertical-slides/#navigation-mode
        navigationMode: 'linear',

        // Randomizes the order of slides each time the presentation loads
        shuffle: false,

        // Turns fragments on and off globally
        fragments: true,

        // Flags whether to include the current fragment in the URL,
        // so that reloading brings you to the same fragment position
        fragmentInURL: false,

        // Flags if the presentation is running in an embedded mode,
        // i.e. contained within a limited portion of the screen
        embedded: false,

        // Flags if we should show a help overlay when the questionmark
        // key is pressed
        help: true,

        // Flags if it should be possible to pause the presentation (blackout)
        pause: true,

        // Flags if speaker notes should be visible to all viewers
        showNotes: false,

        // Global override for autoplaying embedded media (null/true/false)
        autoPlayMedia: null,

        // Global override for preloading lazy-loaded iframes (null/true/false)
        preloadIframes: null,

        // Number of milliseconds between automatically proceeding to the
        // next slide, disabled when set to 0, this value can be overwritten
        // by using a data-autoslide attribute on your slides
        autoSlide: 0,

        // Stop auto-sliding after user input
        autoSlideStoppable: true,

        // Use this method for navigation when auto-sliding
        autoSlideMethod: null,

        // Specify the average time in seconds that you think you will spend
        // presenting each slide. This is used to show a pacing timer in the
        // speaker view
        defaultTiming: null,

        // Enable slide navigation via mouse wheel
        mouseWheel: false,

        // The display mode that will be used to show slides
        display: 'block',

        // Hide cursor if inactive
        hideInactiveCursor: true,

        // Time before the cursor is hidden (in ms)
        hideCursorTime: 5000,

        // Opens links in an iframe preview overlay
        previewLinks: false,

        // Transition style (none/fade/slide/convex/concave/zoom)
        transition: 'none',

        // Transition speed (default/fast/slow)
        transitionSpeed: 'default',

        // Transition style for full page slide backgrounds
        // (none/fade/slide/convex/concave/zoom)
        backgroundTransition: 'none',

        // Number of slides away from the current that are visible
        viewDistance: 3,

        // Number of slides away from the current that are visible on mobile
        // devices. It is advisable to set this to a lower number than
        // viewDistance in order to save resources.
        mobileViewDistance: 2,

        // The "normal" size of the presentation, aspect ratio will be preserved
        // when the presentation is scaled to fit different resolutions. Can be
        // specified using percentage units.
        width: 1050,

        height: 700,

        // Factor of the display size that should remain empty around the content
        margin: 0.1,

        math: {
          mathjax: 'https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/MathJax.js',
          config: 'TeX-AMS_HTML-full',
          tex2jax: {
            inlineMath: [['\\(','\\)']],
            displayMath: [['\\[','\\]']],
            balanceBraces: true,
            processEscapes: false,
            processRefs: true,
            processEnvironments: true,
            preview: 'TeX',
            skipTags: ['script','noscript','style','textarea','pre','code'],
            ignoreClass: 'tex2jax_ignore',
            processClass: 'tex2jax_process'
          },
        },

        // reveal.js plugins
        plugins: [QuartoLineHighlight, PdfExport, RevealMenu, QuartoSupport,

          RevealMath,
          RevealNotes,
          RevealSearch,
          RevealZoom
        ]
      });
    </script>
    
    <script>
      // htmlwidgets need to know to resize themselves when slides are shown/hidden.
      // Fire the "slideenter" event (handled by htmlwidgets.js) when the current
      // slide changes (different for each slide format).
      (function () {
        // dispatch for htmlwidgets
        function fireSlideEnter() {
          const event = window.document.createEvent("Event");
          event.initEvent("slideenter", true, true);
          window.document.dispatchEvent(event);
        }

        function fireSlideChanged(previousSlide, currentSlide) {
          fireSlideEnter();

          // dispatch for shiny
          if (window.jQuery) {
            if (previousSlide) {
              window.jQuery(previousSlide).trigger("hidden");
            }
            if (currentSlide) {
              window.jQuery(currentSlide).trigger("shown");
            }
          }
        }

        // hookup for slidy
        if (window.w3c_slidy) {
          window.w3c_slidy.add_observer(function (slide_num) {
            // slide_num starts at position 1
            fireSlideChanged(null, w3c_slidy.slides[slide_num - 1]);
          });
        }

      })();
    </script>

    <script id="quarto-html-after-body" type="application/javascript">
    window.document.addEventListener("DOMContentLoaded", function (event) {
      const toggleBodyColorMode = (bsSheetEl) => {
        const mode = bsSheetEl.getAttribute("data-mode");
        const bodyEl = window.document.querySelector("body");
        if (mode === "dark") {
          bodyEl.classList.add("quarto-dark");
          bodyEl.classList.remove("quarto-light");
        } else {
          bodyEl.classList.add("quarto-light");
          bodyEl.classList.remove("quarto-dark");
        }
      }
      const toggleBodyColorPrimary = () => {
        const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
        if (bsSheetEl) {
          toggleBodyColorMode(bsSheetEl);
        }
      }
      toggleBodyColorPrimary();  
      const tabsets =  window.document.querySelectorAll(".panel-tabset-tabby")
      tabsets.forEach(function(tabset) {
        const tabby = new Tabby('#' + tabset.id);
      });
      const isCodeAnnotation = (el) => {
        for (const clz of el.classList) {
          if (clz.startsWith('code-annotation-')) {                     
            return true;
          }
        }
        return false;
      }
      const onCopySuccess = function(e) {
        // button target
        const button = e.trigger;
        // don't keep focus
        button.blur();
        // flash "checked"
        button.classList.add('code-copy-button-checked');
        var currentTitle = button.getAttribute("title");
        button.setAttribute("title", "Copied!");
        let tooltip;
        if (window.bootstrap) {
          button.setAttribute("data-bs-toggle", "tooltip");
          button.setAttribute("data-bs-placement", "left");
          button.setAttribute("data-bs-title", "Copied!");
          tooltip = new bootstrap.Tooltip(button, 
            { trigger: "manual", 
              customClass: "code-copy-button-tooltip",
              offset: [0, -8]});
          tooltip.show();    
        }
        setTimeout(function() {
          if (tooltip) {
            tooltip.hide();
            button.removeAttribute("data-bs-title");
            button.removeAttribute("data-bs-toggle");
            button.removeAttribute("data-bs-placement");
          }
          button.setAttribute("title", currentTitle);
          button.classList.remove('code-copy-button-checked');
        }, 1000);
        // clear code selection
        e.clearSelection();
      }
      const getTextToCopy = function(trigger) {
          const codeEl = trigger.previousElementSibling.cloneNode(true);
          for (const childEl of codeEl.children) {
            if (isCodeAnnotation(childEl)) {
              childEl.remove();
            }
          }
          return codeEl.innerText;
      }
      const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
        text: getTextToCopy
      });
      clipboard.on('success', onCopySuccess);
      if (window.document.getElementById('quarto-embedded-source-code-modal')) {
        const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
          text: getTextToCopy,
          container: window.document.getElementById('quarto-embedded-source-code-modal')
        });
        clipboardModal.on('success', onCopySuccess);
      }
        var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
        var mailtoRegex = new RegExp(/^mailto:/);
          var filterRegex = new RegExp('/' + window.location.host + '/');
        var isInternal = (href) => {
            return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
        }
        // Inspect non-navigation links and adorn them if external
     	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
        for (var i=0; i<links.length; i++) {
          const link = links[i];
          if (!isInternal(link.href)) {
            // undo the damage that might have been done by quarto-nav.js in the case of
            // links that we want to consider external
            if (link.dataset.originalHref !== undefined) {
              link.href = link.dataset.originalHref;
            }
          }
        }
      function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
        const config = {
          allowHTML: true,
          maxWidth: 500,
          delay: 100,
          arrow: false,
          appendTo: function(el) {
              return el.closest('section.slide') || el.parentElement;
          },
          interactive: true,
          interactiveBorder: 10,
          theme: 'light-border',
          placement: 'bottom-start',
        };
        if (contentFn) {
          config.content = contentFn;
        }
        if (onTriggerFn) {
          config.onTrigger = onTriggerFn;
        }
        if (onUntriggerFn) {
          config.onUntrigger = onUntriggerFn;
        }
          config['offset'] = [0,0];
          config['maxWidth'] = 700;
        window.tippy(el, config); 
      }
      const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
      for (var i=0; i<noterefs.length; i++) {
        const ref = noterefs[i];
        tippyHover(ref, function() {
          // use id or data attribute instead here
          let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
          try { href = new URL(href).hash; } catch {}
          const id = href.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note) {
            return note.innerHTML;
          } else {
            return "";
          }
        });
      }
      const findCites = (el) => {
        const parentEl = el.parentElement;
        if (parentEl) {
          const cites = parentEl.dataset.cites;
          if (cites) {
            return {
              el,
              cites: cites.split(' ')
            };
          } else {
            return findCites(el.parentElement)
          }
        } else {
          return undefined;
        }
      };
      var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
      for (var i=0; i<bibliorefs.length; i++) {
        const ref = bibliorefs[i];
        const citeInfo = findCites(ref);
        if (citeInfo) {
          tippyHover(citeInfo.el, function() {
            var popup = window.document.createElement('div');
            citeInfo.cites.forEach(function(cite) {
              var citeDiv = window.document.createElement('div');
              citeDiv.classList.add('hanging-indent');
              citeDiv.classList.add('csl-entry');
              var biblioDiv = window.document.getElementById('ref-' + cite);
              if (biblioDiv) {
                citeDiv.innerHTML = biblioDiv.innerHTML;
              }
              popup.appendChild(citeDiv);
            });
            return popup.innerHTML;
          });
        }
      }
    });
    </script>
    

</body></html>